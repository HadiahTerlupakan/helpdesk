<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Helpdesk</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #075e54;
            --secondary-color: #128c7e;
            --light-green: #25d366;
            --message-out-bg: #dcf8c6;
            --message-in-bg: white;
            --background-grey: #f8f9fa;
            --chat-list-hover: rgba(255, 255, 255, 0.2);
            --chat-list-selected: rgba(255, 255, 255, 0.3);
            --chat-bg: #e5ddd5;
            --input-bg: #f0f0f0;
            --text-light: white;
            --text-dark: #333;
            --text-muted: #555;
            --border-color: #ccc;
            --error-color: red;
            --button-danger-bg: #d9534f;
            --button-danger-hover: #c9302c;
            --button-warning-bg: #f0ad4e; /* Warna untuk tombol close/open */
            --button-warning-hover: #ec971f;
            --disabled-color: #aaa;
            --button-neutral-bg: #6c757d; /* Warna abu-abu untuk Release/Unpick */
            --button-neutral-hover: #5a6268;

            /* Quick Reply Colors */
            --quick-reply-bg: #e0e0e0;
            --quick-reply-hover-bg: #d5d5d5;
            --quick-reply-text: var(--text-dark);
             --quick-reply-shortcut-text: var(--primary-color); /* Warna untuk pintasan di list editable */
        }

        /* Reset default styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex; /* Gunakan flex untuk menata sidebar dan chat area */
            height: 100vh;
            background-color: var(--background-grey);
            font-family: 'Segoe UI', Arial, sans-serif;
            overflow: hidden; /* Mencegah scroll body */
             /* Hapus padding-bottom, footer akan di dalam chat-area flex */
            padding-bottom: 0;
        }

        #app-container { display: flex; width: 100%; height: 100%; }
        /* Keep login container hidden */
        #login-container.hidden { display: none; }
        /* Ensure app container is flex when not hidden */
        #app-container:not(.hidden) { display: flex; }
        #app-container.hidden { display: none; }


        #sidebar {
            width: 300px;
            background: var(--primary-color);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            height: 100vh; /* Sidebar setinggi viewport */
            flex-shrink: 0; /* Mencegah sidebar menyusut */
             overflow: hidden; /* Pastikan konten di sidebar tidak overflow */
        }

        #sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0; /* Tidak menyusut */
        }
        #sidebar-header h2 { margin: 0 0 5px 0; font-size: 1.3em;}
        #sidebar-header h3 { margin: 5px 0 5px 0; font-size: 1em; color: #eee; }
        #admin-username-display { font-weight: normal; font-size: 0.9em; color: #ddd; }
        #whatsapp-status { font-size: 0.8em; color: rgba(255,255,255,0.7); margin-top: 5px;}
         #admin-role-display { font-size: 0.8em; color: rgba(255,255,255,0.7); margin-top: 2px; font-style: italic;} /* Tampilkan role */


        #active-chats {
            flex: 1; /* Memenuhi sisa ruang vertikal di sidebar */
            overflow-y: auto; /* Scrollable */
            padding: 0 10px 10px 10px;
        }
         /* Style scrollbar */
        #active-chats::-webkit-scrollbar { width: 8px; }
        #active-chats::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 10px; }
        #active-chats::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
        #active-chats::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }


        #chat-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #chat-list li {
            padding: 12px 15px;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s, border-left 0.2s;
            border-left: 4px solid transparent;
             position: relative; /* Untuk status chat */
        }

        #chat-list li:hover {
            background: var(--chat-list-hover);
        }

        #chat-list li.selected {
            background: var(--chat-list-selected);
            border-left: 4px solid var(--light-green);
        }
         #chat-list li.closed {
             opacity: 0.7; /* Kurangi opacity untuk chat tertutup */
             background: rgba(255,255,255,0.05);
         }
          #chat-list li.closed.selected {
             border-left: 4px solid var(--button-warning-bg);
          }
          /* Style for chat picked by the current user */
          #chat-list li.picked-by-me {
             background: rgba(255, 255, 255, 0.25); /* Slightly different background */
          }
           #chat-list li.picked-by-me.selected {
             background: rgba(255, 255, 255, 0.35);
          }


        #logout-button {
            padding: 12px 15px;
            background: var(--button-danger-bg);
            color: var(--text-light);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 15px;
            text-align: center;
            flex-shrink: 0; /* Tidak menyusut */
        }
        #logout-button:hover { background: var(--button-danger-hover); }


        #chat-area {
            flex: 1; /* Memenuhi sisa ruang horizontal di samping sidebar */
            display: flex;
            flex-direction: column; /* Tata elemen di dalam chat area secara vertikal */
            height: 100vh; /* Chat area setinggi viewport */
            background-color: var(--chat-bg);
             overflow: hidden; /* Ensure content inside chat area doesn't overflow vertically */
        }

        #chat-area-header {
             padding: 10px 20px;
             background: var(--input-bg);
             border-bottom: 1px solid var(--border-color);
             display: flex; /* Use flexbox */
             justify-content: space-between; /* Space between info and actions */
             align-items: center; /* Vertically center items */
             min-height: 50px;
             flex-shrink: 0; /* Tidak menyusut */
             flex-wrap: wrap; /* Allow items to wrap on smaller screens */
             gap: 10px; /* Add space between flex items */
        }
         /* Ensure chat info and actions take appropriate space and don't overflow */
        #current-chat-info { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; } /* Container for name & status */
         #current-chat-id-display { font-weight: bold; color: var(--text-dark); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
         #current-chat-status { font-size: 0.9em; margin-top: 2px; padding: 2px 8px; border-radius: 4px; font-weight: bold; color: var(--text-light); display: inline-block; margin-right: 10px;} /* Add margin-right */

         #chat-picked-status { font-size: 0.9em; color: var(--text-muted); margin-top: 2px;} /* Picked status below chat name */


        #chat-actions-area { display: flex; align-items: center; flex-shrink: 0; gap: 10px; flex-wrap: wrap; } /* Container for pick/delegate/close buttons, allow wrap */
        #pick-chat-button {
             padding: 6px 12px;
             font-size: 0.9em;
             cursor: pointer;
             background-color: var(--light-green);
             color: var(--text-light);
             border: none;
             border-radius: 4px;
             transition: background-color 0.2s;
             flex-shrink: 0;
        }
        #pick-chat-button:disabled { background-color: var(--disabled-color); cursor: default; }
        #pick-chat-button:hover:not(:disabled) { background-color: #22b856; }

        /* New button for Release/Unpick */
         #release-chat-button {
             padding: 6px 12px;
             font-size: 0.9em;
             cursor: pointer;
             background-color: var(--button-neutral-bg); /* Abu-abu */
             color: var(--text-light);
             border: none;
             border-radius: 4px;
             transition: background-color 0.2s;
             flex-shrink: 0;
         }
         #release-chat-button:disabled { background-color: var(--disabled-color); cursor: default; }
         #release-chat-button:hover:not(:disabled) { background-color: var(--button-neutral-hover); }


        #delegate-chat-container { display: flex; align-items: center; gap: 10px; flex-shrink: 0; flex-wrap: wrap; } /* Allow wrap */
        #delegate-chat-select { padding: 6px 12px; font-size: 0.9em; border-radius: 4px; border: 1px solid var(--border-color); cursor: pointer; background: white;} /* Add background for visibility */
        #delegate-chat-select option.online { color: green; }
        #delegate-chat-select option.offline { color: red; opacity: 0.8; } /* Add opacity for offline */
        #delegate-chat-select option:disabled { color: var(--disabled-color); } /* Style for disabled option */

        #delegate-chat-button {
             padding: 6px 12px;
             font-size: 0.9em;
             cursor: pointer;
             background-color: var(--secondary-color);
             color: var(--text-light);
             border: none;
             border-radius: 4px;
             transition: background-color 0.2s;
             flex-shrink: 0;
        }
        #delegate-chat-button:disabled { background-color: var(--disabled-color); cursor: default; }
        #delegate-chat-button:hover:not(:disabled) { background-color: #0b6b5a; }

         #close-chat-button {
             padding: 6px 12px;
             font-size: 0.9em;
             cursor: pointer;
             background-color: var(--button-warning-bg);
             color: var(--text-light);
             border: none;
             border-radius: 4px;
             transition: background-color 0.2s;
             flex-shrink: 0;
         }
          #close-chat-button:disabled { background-color: var(--disabled-color); cursor: default; }
         #close-chat-button:hover:not(:disabled) { background-color: var(--button-warning-hover); }

         #open-chat-button { /* Style for Open Chat Button */
             padding: 6px 12px;
             font-size: 0.9em;
             cursor: pointer;
             background-color: var(--light-green); /* Using light green for open */
             color: var(--text-light);
             border: none;
             border-radius: 4px;
             transition: background-color 0.2s;
             flex-shrink: 0;
         }
          #open-chat-button:disabled { background-color: var(--disabled-color); cursor: default; }
         #open-chat-button:hover:not(:disabled) { background-color: #22b856; }


        /* Super Admin Panel */
         #superadmin-panel {
            background: rgba(0,0,0,0.1); /* Slightly transparent */
            padding: 15px;
             border-top: 1px solid rgba(255,255,255,0.1); /* Top border */
             display: none; /* Hidden by default, controlled by JS flex */
             flex-direction: column;
             gap: 10px;
             flex-shrink: 0;
             margin-top: auto; /* Push to the bottom */
             overflow: hidden; /* Hide anything that pushes out */
         }
         #superadmin-panel .panel-title {
             font-weight: bold;
             color: yellow;
             font-size: 1em;
             text-align: center;
             margin-bottom: 5px;
         }
         #superadmin-panel button {
             padding: 8px 12px; /* Slightly larger buttons */
             font-size: 0.9em;
             border: none;
             border-radius: 4px;
             cursor: pointer;
              transition: background-color 0.2s;
              width: 100%; /* Full width */
              text-align: left; /* Align text left */
              display: flex; /* Use flex for icon alignment */
              align-items: center;
              gap: 8px; /* Space between icon and text */
         }
         #superadmin-panel .delete-chat-button { background-color: var(--button-danger-bg); color: var(--text-light); }
         #superadmin-panel .delete-chat-button:hover { background-color: var(--button-danger-hover); }
         #superadmin-panel .delete-all-chats-button { background-color: #c0392b; color: var(--text-light); } /* Darker red */
         #superadmin-panel .delete-all-chats-button:hover { background-color: #a93226; }
         #superadmin-panel .add-admin-button { background-color: var(--secondary-color); color: var(--text-light); }
         #superadmin-panel .add-admin-button:hover { background-color: #0b6b5a; }
          #superadmin-panel .delete-admin-button { background-color: #dc3545; } /* Warna merah */
         #superadmin-panel .delete-admin-button:hover { background-color: #c82333; }
         #superadmin-panel .show-qr-button { background-color: #673ab7; color: var(--text-light); } /* Purple color */
         #superadmin-panel .show-qr-button:hover { background-color: #5e35b1; }
         /* New Quick Reply Button in Super Admin Panel */
         #superadmin-panel .manage-quick-replies-button { background-color: #ff9800; color: var(--text-dark); } /* Orange */
         #superadmin-panel .manage-quick-replies-button:hover { background-color: #f57c00; }


         /* Ensure icon has base styling */
          #superadmin-panel button i { font-size: 1.1em; }


         /* Modal for QR Code Display (New) */
         #qrModal {
             display: none;
             position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             background: rgba(0,0,0,0.8); z-index: 2000;
             justify-content: center; align-items: center;
         }
          #qrModal .modal-content {
             text-align: center;
             width: 350px;
             max-width: 90%; /* Responsive */
              position: relative; /* Added for close button */
          }
           /* Style for modal close button (placed inside modal-content) */
          #qrModal .modal-content .close-modal-button {
              position: absolute;
              top: 10px; right: 10px;
              font-size: 24px; font-weight: bold;
              background: none; border: none;
              color: var(--text-muted); cursor: pointer;
              padding: 5px; margin: 0;
              transition: color 0.2s;
         }
          #qrModal .modal-content .close-modal-button:hover { color: var(--text-dark); }

         #qrModal h3 { margin-top: 0; margin-bottom: 15px; color: var(--primary-color); }
         #qrModal p { font-size: 0.9em; color: var(--text-muted); margin-bottom: 8px; }
         #qrModal #qr-code { margin: 20px auto; width: 200px; height: 200px; } /* Match login page size */
         #qrModal #qr-code img { max-width: 100%; height: auto; }
         #qrModal #qr-status { font-size: 0.9em; color: var(--text-dark); margin-top: 10px;}
          /* Removed explicit style for close button here, using generic style */
          /* #qrModal .close-modal-button {
             margin-top: 20px;
             background-color: #ccc;
             color: var(--text-dark);
             padding: 8px 20px;
             border: none; border-radius: 4px; cursor: pointer;
             transition: background-color 0.2s;
          }
          #qrModal .close-modal-button:hover { background-color: #bbb; } */


         /* Add Admin Modal */
         #addAdminModal {
             display: none;
             position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             background: rgba(0,0,0,0.8); z-index: 2000;
             justify-content: center; align-items: center;
         }
          /* Added position: relative to modal-content for absolute positioning of close button */
         #addAdminModal .modal-content {
            text-align: left; /* Align text left in form */
            width: 350px; /* Wider modal for form */
            max-width: 90%; /* Responsive */
             position: relative; /* Added */
         }
          /* Added style for the new close button inside modal-content */
          #addAdminModal .modal-content .close-modal-button {
              position: absolute;
              top: 10px; right: 10px;
              font-size: 24px; font-weight: bold;
              background: none; border: none;
              color: var(--text-muted); cursor: pointer;
              padding: 5px; margin: 0;
              transition: color 0.2s;
         }
         #addAdminModal .modal-content .close-modal-button:hover { color: var(--text-dark); }

         #addAdminModal h3 { text-align: center; margin-bottom: 20px; } /* Center modal title */
         #addAdminModal label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: var(--text-dark); } /* Labels for form */
         #addAdminModal input, #addAdminModal select {
             display: block; margin-bottom: 15px; padding: 10px; width: 100%;
             border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; background: white;
         }
          #addAdminModal button { width: auto; margin-top: 10px; }
          #addAdminModal .modal-buttons { text-align: center; } /* Center buttons */
          /* Removed redundant style for close button here */
         /* #addAdminModal .close-modal-button { background-color: #ccc; margin-left: 10px;} */
         /* #addAdminModal .close-modal-button:hover { background-color: #bbb;} */
         #addAdminModal .add-admin-form-status {
             font-size: 0.9em; margin-top: 10px; min-height: 1.2em; /* Ensure space */
             text-align: center; /* Center status message */
         }
         #addAdminModal .add-admin-form-status.success { color: var(--light-green); }
         #addAdminModal .add-admin-form-status.error { color: var(--error-color); }

        /* Delete Admin Modal */
         #deleteAdminModal {
             display: none;
             position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             background: rgba(0,0,0,0.8); z-index: 2000;
             justify-content: center; align-items: center;
         }
          #deleteAdminModal .modal-content {
             text-align: left;
             width: 350px;
             max-width: 90%; /* Responsive */
              position: relative; /* Added for close button */
          }
          /* Style for modal close button (placed inside modal-content) */
          #deleteAdminModal .modal-content .close-modal-button {
              position: absolute;
              top: 10px; right: 10px;
              font-size: 24px; font-weight: bold;
              background: none; border: none;
              color: var(--text-muted); cursor: pointer;
              padding: 5px; margin: 0;
              transition: color 0.2s;
         }
          #deleteAdminModal .modal-content .close-modal-button:hover { color: var(--text-dark); }

         #deleteAdminModal h3 { text-align: center; margin-bottom: 20px;}
         #deleteAdminModal label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: var(--text-dark);}
         #deleteAdminModal select {
             display: block; margin-bottom: 15px; padding: 10px; width: 100%;
             border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; background: white;
             cursor: pointer;
         }
         #deleteAdminModal button { width: auto; margin-top: 10px;}
         #deleteAdminModal .modal-buttons { text-align: center;}
         /* Removed redundant style for close button here */
         /* #deleteAdminModal .close-modal-button { background-color: #ccc; margin-left: 10px;} */
         /* #deleteAdminModal .close-modal-button:hover { background-color: #bbb;} */
         #deleteAdminModal .delete-admin-form-status {
             font-size: 0.9em; margin-top: 10px; min-height: 1.2em;
             text-align: center;
             color: var(--error-color); /* Default error color */
         }
          #deleteAdminModal .delete-admin-form-status.success { color: var(--light-green); }


        #messages {
            flex: 1; /* Memenuhi sisa ruang vertikal */
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
             /* Style scrollbar */
            ::-webkit-scrollbar { width: 8px; }
            ::-webkit-scrollbar-track { background: var(--chat-bg); }
            ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
            ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 7.5px;
            max-width: 70%;
            word-wrap: break-word;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.1); /* Adjusted shadow */
            position: relative;
             font-size: 0.95em; /* Slightly smaller font in bubble */
             /* Flex properties for bubble alignment */
            display: flex;
            flex-direction: column; /* Stack content and timestamp */
        }
        /* Style for sender initials within outgoing message bubble */
         .message.outgoing strong {
             display: inline; /* Show sender name (initials) inside bubble for outgoing */
             margin-right: 5px;
             font-weight: bold;
             color: var(--primary-color); /* Or another distinct color */
         }
         .message.incoming strong {
             display: none; /* Hide sender name inside bubble for incoming */
         }


        .message.incoming {
            background: var(--message-in-bg);
            align-self: flex-start;
            margin-right: auto; /* Push to left */
        }

        .message.outgoing {
            background: var(--message-out-bg);
            align-self: flex-end;
            margin-left: auto; /* Push to right */
        }

         /* Timestamp inside message bubble */
         .message-timestamp {
             display: block;
             font-size: 0.75em;
             color: rgba(0,0,0,0.4);
             text-align: right;
             margin-top: 5px;
         }


        .message img, .message video {
            max-width: 100%; /* Ensure media fits inside the bubble */
            max-height: 300px; /* Limit height for preview */
            display: block;
            margin-top: 5px; /* Space above media if it's not first */
            border-radius: 5px;
            object-fit: contain; /* Ensure content is not stretched */
        }
         /* Remove top margin if media is the first item in the bubble or follows initials */
         .message img:first-child, .message video:first-child, .message audio:first-child, .message a:first-child,
         .message strong:first-child + img, .message strong:first-child + video, .message strong:first-child + audio, .message strong:first-child + a
         {
            margin-top: 0;
         }


        .message img[onclick] { cursor: pointer; }
        .message audio { max-width: 100%; display: block; margin-top: 5px; }
        .message a { color: var(--primary-color); text-decoration: none; margin-top: 5px; display: inline-block; word-break: break-word; }
        .message a:hover { text-decoration: underline; }
        .message .caption, .message .text-content {
            font-size: 1em; white-space: pre-wrap;
             margin-top: 5px; /* Add margin above text/caption if it follows previous content */
        }
         /* Remove top margin if text/caption is the first item or follows initials/media */
         .message .text-content:first-child, .message .caption:first-child,
         .message strong + .text-content, .message strong + .caption,
         .message img + .text-content, .message img + .caption,
         .message video + .text-content, .message video + .caption,
         .message audio + .text-content, .message audio + .caption,
         .message a + .text-content, .message a + .caption
         {
             margin-top: 0;
         }

         .message .document-link {
             display: inline-flex; /* Use flex for icon and text alignment */
             align-items: center;
         }
         .message .document-link i { margin-right: 5px; }


        #reply-box {
            padding: 10px 20px;
            background: var(--input-bg);
            display: flex;
            flex-direction: column; /* Use column to stack input, quick replies, and preview */
            border-top: 1px solid var(--border-color);
            min-height: 60px; /* Adjusted min height */
            position: relative;
            flex-shrink: 0; /* Tidak menyusut */
        }
         #reply-box.disabled {
             opacity: 0.7;
             pointer-events: none; /* Disable interactions */
         }

        /* New Quick Reply Buttons Container */
        #quick-replies-container {
             display: flex;
             flex-wrap: wrap; /* Allow buttons to wrap */
             gap: 8px; /* Space between buttons */
             margin-top: 10px; /* Space above input area */
             padding-top: 5px; /* Small padding top */
             border-top: 1px solid rgba(0,0,0,0.1); /* Separator line */
        }
        #quick-replies-container button {
             padding: 5px 10px;
             font-size: 0.85em;
             border: 1px solid var(--border-color);
             border-radius: 15px; /* Pill shape */
             background-color: var(--quick-reply-bg);
             color: var(--quick-reply-text);
             cursor: pointer;
             transition: background-color 0.2s, border-color 0.2s;
             max-width: 100%; /* Prevent overflow */
             overflow: hidden;
             text-overflow: ellipsis;
             white-space: nowrap; /* Keep text on one line */
        }
         #quick-replies-container button:hover:not(:disabled) {
             background-color: var(--quick-reply-hover-bg);
             border-color: var(--text-muted);
         }
         #quick-replies-container button:disabled {
             opacity: 0.5;
             cursor: default;
         }


        .reply-input-container {
             display: flex;
             align-items: center;
             width: 100%;
             margin-top: 10px; /* Space above input row */
        }

        #reply-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            margin-right: 10px;
            font-size: 1em;
            resize: none; /* Gunakan textarea untuk resize otomatis */
            min-height: 22px; /* Default height for one row */
            max-height: 150px; /* Batas ketinggian agar tidak terlalu besar */
            overflow-y: auto;
             line-height: 1.4; /* Better line height for textareas */
             background: white; /* Add background for visibility */
             color: var(--text-dark); /* Ensure text color is dark */
        }
         /* Style scrollbar for textarea */
        #reply-input::-webkit-scrollbar { width: 8px; }
        #reply-input::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 10px; }
        #reply-input::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        #reply-input::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }

        #reply-input:disabled { background-color: #e9e9e9; }

        #media-button {
             background: none; border: none; font-size: 1.3em; cursor: pointer; color: var(--text-muted); margin-right: 10px;
             transition: color 0.2s; flex-shrink: 0; padding: 0 5px; /* Add padding around icon */
        }
         #media-button i { pointer-events: none; } /* Prevent icon itself from capturing click */
        #media-button:hover { color: var(--text-dark); }
        #media-button:disabled { color: var(--disabled-color); cursor: default; }


        #reply-button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--text-light);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        #reply-button:disabled { background-color: var(--disabled-color); cursor: default; }
        #reply-button:hover:not(:disabled) { background: var(--secondary-color); }
        #reply-button i { margin-right: 5px; }

        /* Media Preview Container */
        #media-preview-container {
            display: flex; /* Use flex for alignment */
            align-items: center;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white; /* Use white background for preview */
            width: calc(100% - 40px); /* Match reply-box padding */
            margin-left: 20px; /* Match reply-box padding */
            margin-bottom: 10px; /* Space below preview */
        }
        #media-preview-container img,
        #media-preview-container video {
            max-width: 50px; max-height: 50px; object-fit: cover; border-radius: 5px; margin-right: 10px;
        }
         #media-preview-container .file-info {
             flex-grow: 1; font-size: 0.9em; color: var(--text-dark); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
         }
         #media-preview-container .clear-media-button {
             background: none; border: none; color: var(--button-danger-bg); font-size: 1.2em; cursor: pointer;
             margin-left: 10px; flex-shrink: 0;
         }
          #media-preview-container .clear-media-button:hover { color: var(--button-danger-hover); }


        /* Send Error Message Style */
        .send-error-span {
            color: var(--error-color);
            font-size: 0.85em;
            position: absolute;
            bottom: 5px; /* Position relative to reply-box bottom */
            left: 20px;
            /* background: var(--input-bg); /* Match background */
            /* padding: 0 5px; */
             z-index: 1; /* Ensure it's above elements */
        }


        /* Login Container */
        #login-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
             flex-direction: column; /* Stack login box and QR area */
            gap: 20px; /* Space between them */
        }
        #login-box {
            background: #fff;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            color: var(--text-dark);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 350px; width: 90%; /* Responsive */
        }
        #login-box h2 {
            margin-top: 0;
            margin-bottom: 25px;
            color: var(--primary-color);
        }
        #login-box input {
            margin-bottom: 15px;
            padding: 12px;
            width: 100%; /* Fill width */
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1em;
        }
        #login-box button {
            padding: 12px 25px; background: var(--primary-color); border: none;
            color: var(--text-light);
            border-radius: 4px;
            cursor: pointer; font-size: 1em; width: 100%;
            transition: background 0.2s; margin-top: 10px;
        }
        #login-box button:hover { background: var(--secondary-color); }
        #login-error {
            color: var(--error-color); margin-top: 15px; font-size: 0.9em; min-height: 1.2em; /* Ensure space */
            font-weight: 500;
        }

         /* Media Modal */
        #mediaModal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.95); /* Darker background */
            justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }
         /* Center the media elements */
        #modalMediaContent, #modalVideoContent, #modalAudioContent {
             display: block; /* Ensure they take space */
             margin: auto; /* Center horizontally */
             object-fit: contain; /* Prevent stretching */
             max-width: 95%; max-height: 95%; /* Limit size */
             box-shadow: 0 4px 15px rgba(0,0,0,0.2); /* Add shadow */
        }
         #modalVideoContent { width: 100%; height: auto; max-width: 800px; max-height: 600px; } /* Adjust video size */
         #modalAudioContent { width: 100%; max-width: 500px; margin-top: 20px; } /* Adjust audio size */

         #modalDocumentContent {
             background: white; padding: 20px; border-radius: 8px; text-align: center;
             width: 300px; max-width: 90%; /* Responsive */
             box-shadow: 0 4px 15px rgba(0,0,0,0.2);
             margin: auto; /* Center horizontally */
         }
         #modalDocumentContent i { font-size: 40px; color: var(--primary-color); }
         #modalDocumentName { margin-top: 10px; font-size: 1.1em; color: var(--text-dark); word-break: break-word;}
         #modalDocumentLink {
             display: inline-block; margin-top: 15px; padding: 8px 16px;
             background: var(--secondary-color); color: white; text-decoration: none; border-radius: 4px;
             transition: background-color 0.2s;
         }
         #modalDocumentLink:hover { background: #0b6b5a; }


        #closeModal {
            position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px;
            font-weight: bold; cursor: pointer; transition: color 0.2s;
            line-height: 1;
            z-index: 2001; /* Above media */
        }
        #closeModal:hover { color: #bbb; }

        /* Generic Modal Style */
         .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1500; justify-content: center; align-items: center;
         }
         .modal-content {
            background: white; padding: 20px; border-radius: 8px; text-align: center;
            width: 300px; max-width: 90%; /* Responsive */
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
             position: relative; /* Added for modal close button positioning */
         }
          /* Style for modal close button (placed inside modal-content) */
          .modal-content .close-modal-button {
              position: absolute;
              top: 10px; /* Adjust as needed */
              right: 10px; /* Adjust as needed */
              font-size: 24px; font-weight: bold;
              background: none; border: none;
              color: var(--text-muted); cursor: pointer;
              padding: 5px; margin: 0;
              transition: color 0.2s;
         }
          .modal-content .close-modal-button:hover { color: var(--text-dark); }


         .modal-content h3 { margin-top: 0; color: var(--primary-color); }
         .modal-content p { color: var(--text-dark); margin-bottom: 20px; }
         .modal-content button {
             padding: 10px 20px; background: var(--primary-color); color: white;
             border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;
         }
          .modal-content button:hover { background: var(--secondary-color); }

         /* Added style for server alerts */
         .server-alert {
             position: fixed; top: 10px; right: 10px;
             padding: 15px 20px; border-radius: 8px;
             color: var(--text-light); z-index: 3000;
             box-shadow: 0 2px 10px rgba(0,0,0,0.2);
             opacity: 1; transition: opacity 0.5s ease-in-out;
         }
         .server-alert.success { background-color: var(--light-green); }
         .server-alert.error { background-color: var(--button-danger-bg); }

        /* Styles for Quick Reply Management Modal */
         #quickReplyModal .modal-content {
             width: 400px; /* Wider modal for list */
             max-height: 80vh; /* Limit height to prevent overflow */
             overflow-y: auto; /* Add scroll if content exceeds height */
             text-align: left; /* Align text left in form */
             position: relative; /* Added for close button */
         }
          /* Style for modal close button (placed inside modal-content) */
          #quickReplyModal .modal-content .close-modal-button {
              position: absolute;
              top: 10px; right: 10px;
              font-size: 24px; font-weight: bold;
              background: none; border: none;
              color: var(--text-muted); cursor: pointer;
              padding: 5px; margin: 0;
              transition: color 0.2s;
         }
          #quickReplyModal .modal-content .close-modal-button:hover { color: var(--text-dark); }

        #quickReplyModal .modal-content h3 { text-align: center; margin-bottom: 20px; }
        #quickReplyModal label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: var(--text-dark); }
        #quickReplyModal input[type="text"], #quickReplyModal textarea { /* Specific selector for new inputs */
             display: block; margin-bottom: 15px; padding: 10px; width: 100%;
             border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; background: white;
             resize: vertical; /* Allow resizing textarea vertically */
             min-height: 50px; /* Minimum height for textarea */
         }
          /* Style for the shortcut input */
         #quickReplyModal input[type="text"]#new-quick-reply-shortcut { /* Added specific ID */
              min-height: 38px; /* Teks biasa, lebih pendek */
              margin-bottom: 5px; /* Space below shortcut input */
         }


         #quickReplyModal .modal-buttons { text-align: center; margin-top: 20px; } /* Center buttons */
         #quickReplyModal .add-template-area { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);}
        #quickReplyModal .quick-reply-list-editable {
             list-style: none;
             padding: 0;
             margin: 0 0 20px 0; /* Space below the list */
         }
        #quickReplyModal .quick-reply-list-editable li {
             display: flex;
             align-items: center;
             justify-content: space-between;
             padding: 8px 0;
             border-bottom: 1px solid #eee;
             font-size: 0.95em;
             color: var(--text-dark);
             gap: 10px; /* Space between text and button */
         }
         #quickReplyModal .quick-reply-list-editable li .template-text {
             flex-grow: 1;
             word-break: break-word; /* Break long text */
             margin-right: 10px; /* Ensure space before button */
         }
          /* Style for the shortcut display in the editable list */
         #quickReplyModal .quick-reply-list-editable li .template-text strong {
             color: var(--quick-reply-shortcut-text);
             font-weight: bold;
             margin-right: 5px; /* Space after shortcut */
         }


         #quickReplyModal .quick-reply-list-editable li .delete-template-button {
             background: none;
             border: none;
             color: var(--button-danger-bg);
             font-size: 1.1em;
             cursor: pointer;
             flex-shrink: 0; /* Prevent button from shrinking */
         }
        #quickReplyModal .quick-reply-list-editable li .delete-template-button:hover {
             color: var(--button-danger-hover);
         }
        #quickReplyModal .quick-reply-form-status {
             font-size: 0.9em; margin-top: 10px; min-height: 1.2em;
             text-align: center;
         }
         #quickReplyModal .quick-reply-form-status.success { color: var(--light-green); }
         #quickReplyModal .quick-reply-form-status.error { color: var(--error-color); }

        /* New Modal for Delete Quick Reply Confirmation */
         #confirmDeleteQRModal {
             display: none;
             position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             background: rgba(0,0,0,0.8); z-index: 2500; /* Higher z-index than other modals */
             justify-content: center; align-items: center;
         }
         #confirmDeleteQRModal .modal-content {
             width: 300px;
              position: relative; /* Added for close button */
         }
          /* Style for modal close button (placed inside modal-content) */
          #confirmDeleteQRModal .modal-content .close-modal-button {
              position: absolute;
              top: 10px; right: 10px;
              font-size: 24px; font-weight: bold;
              background: none; border: none;
              color: var(--text-muted); cursor: pointer;
              padding: 5px; margin: 0;
              transition: color 0.2s;
         }
         #confirmDeleteQRModal .modal-content .close-modal-button:hover { color: var(--text-dark); }


          #confirmDeleteQRModal .modal-content p {
              margin-bottom: 25px; /* More space before buttons */
          }
         #confirmDeleteQRModal .modal-buttons {
             display: flex;
             justify-content: space-around; /* Space buttons out */
             gap: 10px; /* Space between buttons */
         }
          #confirmDeleteQRModal .modal-buttons button {
             flex-grow: 1; /* Make buttons fill space */
             padding: 10px; /* Larger padding */
          }
          #confirmDeleteQRModal #confirm-delete-qr-yes {
             background-color: var(--button-danger-bg);
             color: var(--text-light); /* Ensure text is white */
          }
           #confirmDeleteQRModal #confirm-delete-qr-yes:hover {
             background-color: var(--button-danger-hover);
           }
          #confirmDeleteQRModal #confirm-delete-qr-no {
             background-color: var(--button-neutral-bg); /* Use neutral gray for Cancel */
              color: var(--text-light); /* Ensure text is white */
          }
           #confirmDeleteQRModal #confirm-delete-qr-no:hover {
             background-color: var(--button-neutral-hover);
           }

         /* NEW: Modal for Delete ALL Chats Confirmation */
         #confirmDeleteAllChatsModal {
             display: none;
             position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             background: rgba(0,0,0,0.8); z-index: 2600; /* Even higher z-index */
             justify-content: center; align-items: center;
         }
          #confirmDeleteAllChatsModal .modal-content {
             width: 350px; /* Slightly wider */
              position: relative; /* Added for close button */
         }
          /* Style for modal close button (placed inside modal-content) */
          #confirmDeleteAllChatsModal .modal-content .close-modal-button {
              position: absolute;
              top: 10px; right: 10px;
              font-size: 24px; font-weight: bold;
              background: none; border: none;
              color: var(--text-muted); cursor: pointer;
              padding: 5px; margin: 0;
              transition: color 0.2s;
         }
         #confirmDeleteAllChatsModal .modal-content .close-modal-button:hover { color: var(--text-dark); }


         #confirmDeleteAllChatsModal .modal-content p {
             margin-bottom: 25px;
              font-weight: bold; /* Emphasize warning */
              color: var(--button-danger-bg); /* Use error color for warning */
         }
          #confirmDeleteAllChatsModal .modal-content p strong {
              color: var(--button-danger-bg); /* Ensure strong text is also red */
          }
         #confirmDeleteAllChatsModal .modal-buttons {
              display: flex;
              justify-content: space-around;
              gap: 10px;
         }
          #confirmDeleteAllChatsModal .modal-buttons button {
             flex-grow: 1;
             padding: 10px;
         }
          #confirmDeleteAllChatsModal #confirm-delete-all-chats-yes {
             background-color: var(--button-danger-bg);
              color: var(--text-light);
          }
          #confirmDeleteAllChatsModal #confirm-delete-all-chats-yes:hover {
             background-color: var(--button-danger-hover);
          }
          #confirmDeleteAllChatsModal #confirm-delete-all-chats-no {
              background-color: var(--button-neutral-bg);
               color: var(--text-light);
          }
           #confirmDeleteAllChatsModal #confirm-delete-all-chats-no:hover {
             background-color: var(--button-neutral-hover);
           }



        /* Footer Style - Moved inside chat-area flex */
        footer {
            text-align: center;
            padding: 10px;
            background: var(--input-bg);
            color: var(--text-muted);
            font-size: 0.9em;
            flex-shrink: 0; /* Prevent shrinking in flex column */
            /* Remove fixed positioning */
        }


    </style>
    <!-- IMPORTANT: Ensure the </style> tag closes the CSS block correctly -->
</head>
<body>
    <!-- Login Container -->
    <div id="login-container" class=""> <!-- Removed hidden class here -->
        <div id="login-box">
            <h2>Admin Helpdesk Login</h2>
            <input type="text" id="username-input" placeholder="Username" autocomplete="username">
            <input type="password" id="password-input" placeholder="Password" autocomplete="current-password">
            <button id="login-button">Login</button>
            <div id="login-error"></div> <!-- Empty initially -->
        </div>
        <!-- QR Code Area is NOW A MODAL -->
    </div>


    <!-- Main App Container (Initially Hidden) -->
    <div id="app-container" class="hidden">
        <!-- Sidebar -->
        <div id="sidebar">
            <div id="sidebar-header">
                <h2>Admin Helpdesk</h2>
                <div id="admin-username-display"></div>
                 <div id="admin-role-display"></div> <!-- Display admin role -->
                 <div id="whatsapp-status">Status WA: Menyambungkan...</div> <!-- WA Status -->
                <h3>Percakasaan Aktif</h3>
            </div>
             <!-- Super Admin Panel in Sidebar -->
            <div id="superadmin-panel"> <!-- Display controlled by JS flex -->
                 <div class="panel-title">Super Admin Panel</div>
                <button id="add-admin-button" title="Tambah Admin Baru"><i class="fas fa-user-plus"></i> Tambah Admin</button>
                 <button id="delete-admin-button" title="Hapus Admin"><i class="fas fa-user-minus"></i> Hapus Admin</button> <!-- New Delete Admin Button -->
                 <!-- New button to manage Quick Replies -->
                 <button id="manage-quick-replies-button" class="manage-quick-replies-button" title="Kelola Template Pesan Cepat"><i class="fas fa-comment-dots"></i> Kelola Pesan Cepat</button>
                 <button id="delete-all-chats-button" title="Hapus Semua Riwayat Chat"><i class="fas fa-trash-alt"></i> Hapus Semua Chat</button>
                 <button id="show-qr-button" title="Tampilkan QR Code WhatsApp"><i class="fas fa-qrcode"></i> Tampilkan QR WhatsApp</button> <!-- NEW QR Button -->
                 <!-- Delete single chat button will be in chat area header -->

            </div>
            <div id="active-chats">
                <ul id="chat-list">
                    <!-- Daftar chat akan diisi oleh JavaScript -->
                     <div class="placeholder" style="color: rgba(255,255,255,0.7); text-align: center; margin-top: 20px;">Memuat percakapan...</div>
                </ul>
            </div>
            <button id="logout-button">Logout</button>
        </div>

        <!-- Chat Area -->
        <div id="chat-area">
            <div id="chat-area-header">
                 <div id="current-chat-info">
                    <span id="current-chat-id-display">Pilih percakapan dari daftar</span>
                     <div> <!-- Container for status and picked status to keep them on one line potentially -->
                        <span id="current-chat-status" style="display: none;"></span> <!-- Chat status -->
                        <span id="chat-picked-status"></span> <!-- Picked status below chat name -->
                     </div>
                 </div>
                <div id="chat-actions-area">
                     <!-- Close/Open chat button -->
                     <button id="close-chat-button" style="display: none;" title="Tutup Percakapan Ini"><i class="fas fa-lock"></i> Tutup Chat</button>
                      <button id="open-chat-button" style="display: none;" title="Buka Kembali Percakapan Ini"><i class="fas fa-lock-open"></i> Buka Chat</button>

                    <button id="pick-chat-button" style="display: none;"><i class="fas fa-hand-paper"></i> Ambil Chat Ini</button> <!-- Icon added -->
                     <!-- New Release Chat Button -->
                    <button id="release-chat-button" style="display: none;" title="Lepas Chat Ini"><i class="fas fa-hand-rock"></i> Lepas Chat</button> <!-- Icon & Text -->

                    <div id="delegate-chat-container" style="display: none;">
                        <select id="delegate-chat-select">
                            <option value="" disabled selected>Pilih Admin</option>
                             <!-- Admin options will be added by JavaScript -->
                        </select>
                        <button id="delegate-chat-button"><i class="fas fa-exchange-alt"></i> Delegasikan</button> <!-- Icon added -->
                    </div>
                     <!-- Delete single chat button for Super Admin -->
                     <button id="delete-chat-button" style="display: none;" class="delete-chat-button" title="Hapus Riwayat Chat Ini"><i class="fas fa-trash"></i> Hapus Chat</button>
                </div>
            </div>
            <div id="messages">
                <div class="placeholder">Pilih percakapan untuk memulai</div>
            </div>
            <div id="reply-box" class="disabled"> <!-- Add disabled class initially -->
                <!-- New Quick Replies Container -->
                <div id="quick-replies-container">
                    <!-- Quick Reply Buttons will be inserted here by JavaScript -->
                     <span style="color: var(--text-muted); font-size: 0.9em;">Memuat pesan cepat...</span>
                </div>
                 <div class="reply-input-container">
                    <button id="media-button" title="Lampirkan Media" disabled><i class="fas fa-paperclip"></i></button>
                    <!-- Mengganti input type="text" dengan textarea -->
                    <textarea id="reply-input" placeholder="Pilih atau ambil chat untuk membalas..." disabled rows="1"></textarea>
                    <button id="reply-button" disabled><i class="fas fa-paper-plane"></i> Kirim</button>
                 </div>
                 <!-- Media preview container added here -->
                 <div id="media-preview-container" style="display: none;">
                    <!-- Media preview and clear button will be added here by JS -->
                 </div>
                 <span class="send-error-span" style="display: none;"></span> <!-- Placeholder for send error -->
            </div>

            <!-- FOOTER - Moved inside #chat-area -->
             <footer>
                 Versi Aplikasi: <span id="app-version">N/A</span>
             </footer>

        </div> <!-- End of #chat-area -->
    </div> <!-- End of #app-container -->


    <!-- Media Modal Structure -->
    <div id="mediaModal" class="modal-overlay">
        <span id="closeModal">×</span>
        <img id="modalMediaContent" src="" alt="Tampilan Media">
         <!-- Add other media types if needed, e.g., video, audio -->
         <video id="modalVideoContent" controls style="display: none;"></video>
         <audio id="modalAudioContent" controls style="display: none;"></audio>
         <div id="modalDocumentContent" style="display: none;">
            <i class="fas fa-file-alt"></i>
            <p id="modalDocumentName"></p>
            <a id="modalDocumentLink" href="#" target="_blank" download>Unduh</a>
         </div>
    </div>

    <!-- Modal for Offline Admin Notification -->
    <div id="offlineAdminModal" class="modal-overlay">
        <div class="modal-content">
             <button class="close-modal-button" data-target-modal="offlineAdminModal">×</button> <!-- Added Close Button -->
            <h3>Admin Offline</h3>
            <p id="offlineAdminMessage">Admin sedang offline.</p>
            <div class="modal-buttons"> <!-- Wrap OK button in modal-buttons for consistent styling -->
                 <button id="offlineAdminModalClose">OK</button>
            </div>
        </div>
    </div>

     <!-- Modal for Add Admin -->
     <div id="addAdminModal" class="modal-overlay">
         <div class="modal-content">
             <!-- NEW: Added Close Button -->
             <button class="close-modal-button" data-target-modal="addAdminModal">×</button>
             <h3>Tambah Admin Baru</h3>
             <label for="new-admin-username">Username:</label>
             <input type="text" id="new-admin-username" placeholder="Username" autocomplete="off">
             <label for="new-admin-password">Password:</label>
             <input type="password" id="new-admin-password" placeholder="Password" autocomplete="new-password">
             <label for="new-admin-initials">Initials:</label>
             <input type="text" id="new-admin-initials" placeholder="Initials (Maks 3 huruf, cth: ADM)" autocomplete="off"> <!-- Updated placeholder -->
             <label for="new-admin-role">Role:</label>
             <select id="new-admin-role">
                 <option value="admin" selected>Admin Biasa</option>
                 <option value="superadmin">Super Admin</option>
             </select>
             <div class="modal-buttons">
                 <button id="submit-add-admin"><i class="fas fa-user-plus"></i> Tambah</button>
                 <!-- The generic close button handler will close this based on data-target-modal -->
                 <!-- <button class="close-modal-button" data-target-modal="addAdminModal">Batal</button> -->
             </div>
             <div class="add-admin-form-status"></div> <!-- Status message -->
         </div>
     </div>

        <!-- Modal for Delete Admin -->
     <div id="deleteAdminModal" class="modal-overlay">
         <div class="modal-content">
              <button class="close-modal-button" data-target-modal="deleteAdminModal">×</button> <!-- Added Close Button -->
             <h3>Hapus Admin</h3>
             <p>Pilih admin yang akan dihapus.</p>
             <label for="delete-admin-select">Admin:</label>
             <select id="delete-admin-select">
                 <option value="" disabled selected>Pilih Admin</option>
                 <!-- Admin options populated by JS -->
             </select>
             <div class="modal-buttons">
                 <button id="submit-delete-admin" class="delete-chat-button"><i class="fas fa-user-minus"></i> Hapus Admin</button> <!-- Using delete-chat-button style -->
                 <!-- <button class="close-modal-button" data-target-modal="deleteAdminModal">Batal</button> -->
             </div>
              <div class="delete-admin-form-status"></div> <!-- Status message -->
         </div>
     </div>

    <!-- Modal for QR Code Display (New) -->
     <div id="qrModal" class="modal-overlay">
         <div class="modal-content">
              <button class="close-modal-button" data-target-modal="qrModal">×</button> <!-- Added Close Button -->
             <h3>WhatsApp Connection</h3>
              <p>Pindai QR Code dengan aplikasi WhatsApp di ponsel Anda:</p>
              <p>Pengaturan > Perangkat Tertaut > Tautkan Perangkat</p>
             <div id="qr-code"></div> <!-- QR Code will be rendered here -->
             <p id="qr-status"></p> <!-- Optional: Status messages like "Scanning..." -->
             <!-- <button class="close-modal-button" data-target-modal="qrModal">Tutup</button> --> <!-- Add close button -->
         </div>
     </div>

     <!-- New Modal for Quick Reply Management (Super Admin) -->
     <div id="quickReplyModal" class="modal-overlay">
         <div class="modal-content">
              <button class="close-modal-button" data-target-modal="quickReplyModal">×</button> <!-- Added Close Button -->
             <h3>Kelola Pesan Cepat</h3>

             <label>Template Saat Ini:</label>
             <ul class="quick-reply-list-editable">
                 <!-- Editable quick replies will be listed here by JS -->
                 <li class="placeholder">Tidak ada template</li>
             </ul>

             <div class="add-template-area">
                 <label for="new-quick-reply-shortcut">Pintasan:</label> <!-- NEW Shortcut input -->
                 <input type="text" id="new-quick-reply-shortcut" placeholder="Cth: sapaan, infoalamat" autocomplete="off"> <!-- Added input for shortcut -->
                 <label for="new-quick-reply-text">Isi Pesan Template:</label>
                 <textarea id="new-quick-reply-text" placeholder="Ketik template pesan baru di sini..."></textarea>
                 <div class="modal-buttons" style="text-align: left;"> <!-- Align add button left -->
                      <button id="add-quick-reply-button"><i class="fas fa-plus"></i> Tambah</button>
                 </div>
             </div>


             <div class="modal-buttons"> <!-- Center Save/Cancel buttons -->
                 <button id="save-quick-replies-button"><i class="fas fa-save"></i> Simpan</button>
                 <button class="close-modal-button" data-target-modal="quickReplyModal">Batal</button>
             </div>
             <div class="quick-reply-form-status"></div> <!-- Status message -->
         </div>
     </div>

    <!-- New Modal for Delete Quick Reply Confirmation -->
     <div id="confirmDeleteQRModal" class="modal-overlay">
         <div class="modal-content">
             <button class="close-modal-button" data-target-modal="confirmDeleteQRModal">×</button> <!-- Added Close Button -->
             <h3>Konfirmasi Hapus</h3>
             <p id="confirm-delete-qr-message">Anda yakin ingin menghapus template ini?</p>
             <div class="modal-buttons">
                 <button id="confirm-delete-qr-yes">Ya, Hapus</button>
                 <button id="confirm-delete-qr-no">Batal</button>
             </div>
         </div>
     </div>

     <!-- NEW: Modal for Delete ALL Chats Confirmation -->
     <div id="confirmDeleteAllChatsModal" class="modal-overlay">
         <div class="modal-content">
              <button class="close-modal-button" data-target-modal="confirmDeleteAllChatsModal">×</button> <!-- Added Close Button -->
             <h3>Konfirmasi Hapus Semua Chat</h3>
             <p><strong>PERINGATAN:</strong> Tindakan ini akan menghapus <br> <strong>SEMUA RIWAYAT CHAT</strong> <br> secara permanen. <br> Ini tidak bisa dibatalkan.</p>
             <p>Lanjutkan?</p>
             <div class="modal-buttons">
                 <button id="confirm-delete-all-chats-yes">Ya, Hapus SEMUA</button>
                 <button id="confirm-delete-all-chats-no">Batal</button>
             </div>
         </div>
     </div>


    <!-- Pastikan path ini benar -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.js"></script> <!-- Library QR Code -->
    <script>
        // --- Socket.IO Setup ---

        // Auto Logout Timer
        let logoutTimer;
        const logoutTime = 15 * 60 * 1000; // 15 menit
        const warningTime = 30 * 1000; // 30 detik

        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            logoutTimer = setTimeout(() => {
                // Tampilkan notifikasi countdown
                const countdown = setInterval(() => {
                    const remaining = Math.ceil(warningTime / 1000);
                    showNotification(`Anda akan logout dalam ${remaining} detik...`);
                    warningTime -= 1000;
                    if (warningTime <= 0) {
                        clearInterval(countdown);
                        logoutButton.click();
                    }
                }, 1000);
            }, logoutTime - warningTime);
        }

        // Reset timer pada aktivitas user
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
            window.addEventListener(event, resetLogoutTimer);
        });

        // Inisialisasi timer
        resetLogoutTimer();
        // Tambahkan transport 'websocket' secara eksplisit jika perlu (tergantung setup server)
        // const socket = io({ transports: ['websocket', 'polling'] });
        const socket = io({
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            randomizationFactor: 0.5
        });


        // --- UI Elements ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const usernameInput = document.getElementById('username-input');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        // QR Modal elements
        const qrModal = document.getElementById('qrModal'); // The new modal overlay
        const qrCodeDiv = qrModal.querySelector('#qr-code'); // Select QR div INSIDE the modal
        const qrStatus = qrModal.querySelector('#qr-status'); // Select status p INSIDE the modal
        const whatsappStatusDiv = document.getElementById('whatsapp-status'); // WA Status Display (stays in sidebar header)


        const adminUsernameDisplay = document.getElementById('admin-username-display');
        const adminRoleDisplay = document.getElementById('admin-role-display'); // Role Display
        const logoutButton = document.getElementById('logout-button');
        const chatList = document.getElementById('chat-list');
        const messagesDiv = document.getElementById('messages');
        const replyInput = document.getElementById('reply-input'); // Now a textarea
        const replyButton = document.getElementById('reply-button');
        const replyBox = document.getElementById('reply-box');
        const sendErrorSpan = replyBox.querySelector('.send-error-span'); // Get the error span

        const currentChatInfoDiv = document.getElementById('current-chat-info'); // Container for name & status
        const currentChatIdDisplay = document.getElementById('current-chat-id-display');
        const currentChatStatusSpan = document.getElementById('current-chat-status'); // Chat status span
        const chatPickedStatus = document.getElementById('chat-picked-status'); // Picked status text

        const chatActionsArea = document.getElementById('chat-actions-area'); // Container for actions
        const pickChatButton = document.getElementById('pick-chat-button');
        const releaseChatButton = document.getElementById('release-chat-button'); // New Release button
        const delegateChatContainer = document.getElementById('delegate-chat-container');
        const delegateChatSelect = document.getElementById('delegate-chat-select');
        const delegateChatButton = document.getElementById('delegate-chat-button');
        const closeChatButton = document.getElementById('close-chat-button'); // Close chat button
        const openChatButton = document.getElementById('open-chat-button'); // Open chat button

        const superadminPanel = document.getElementById('superadmin-panel'); // Super Admin Panel
        const addAdminButton = document.getElementById('add-admin-button'); // Add Admin Button
        const deleteAdminButton = document.getElementById('delete-admin-button'); // New Delete Admin Button
         const manageQuickRepliesButton = document.getElementById('manage-quick-replies-button'); // NEW Manage Quick Replies Button
        const deleteAllChatsButton = document.getElementById('delete-all-chats-button'); // Delete All Chats Button
        const showQrButton = document.getElementById('show-qr-button'); // NEW Show QR Button
        const deleteChatButton = document.getElementById('delete-chat-button'); // Delete Single Chat Button

        const mediaButton = document.getElementById('media-button');
        const mediaInput = document.createElement('input'); // File input for media upload
        mediaInput.type = 'file';
        // Allow common image, video, audio, and PDF files, plus common office documents
        mediaInput.accept = 'image/*,video/*,audio/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,text/plain'; // Added text/plain
        mediaInput.style.display = 'none'; // Hide the input
        document.body.appendChild(mediaInput);

        const mediaPreviewContainer = document.getElementById('media-preview-container'); // Container for preview
        let selectedMedia = null; // State variable to hold selected media file data

        // Media Modal Elements
        const mediaModal = document.getElementById('mediaModal');
        const closeModal = document.getElementById('closeModal');
        const modalMediaContent = document.getElementById('modalMediaContent'); // Image
        const modalVideoContent = document.getElementById('modalVideoContent'); // Video
        const modalAudioContent = document.getElementById('modalAudioContent'); // Audio
        const modalDocumentContent = document.getElementById('modalDocumentContent'); // Document
        const modalDocumentName = document.getElementById('modalDocumentName');
        const modalDocumentLink = document.getElementById('modalDocumentLink');

        // Modal for Offline Admin Notification
        const offlineAdminModal = document.getElementById('offlineAdminModal');
        const offlineAdminMessage = document.getElementById('offlineAdminMessage');
        const offlineAdminModalClose = document.getElementById('offlineAdminModalClose');

        // Modal for Add Admin
        const addAdminModal = document.getElementById('addAdminModal');
        const newAdminUsernameInput = document.getElementById('new-admin-username');
        const newAdminPasswordInput = document.getElementById('new-admin-password');
        const newAdminInitialsInput = document.getElementById('new-admin-initials');
        const newAdminRoleSelect = document.getElementById('new-admin-role');
        const submitAddAdminButton = document.getElementById('submit-add-admin');
        const addAdminFormStatusDiv = addAdminModal.querySelector('.add-admin-form-status');

        // Modal for Delete Admin
        const deleteAdminModal = document.getElementById('deleteAdminModal'); // New Delete Admin Modal
        const deleteAdminSelect = document.getElementById('delete-admin-select'); // New Delete Admin Select
        const submitDeleteAdminButton = document.getElementById('submit-delete-admin'); // New Delete Admin Submit Button
        const deleteAdminFormStatusDiv = deleteAdminModal.querySelector('.delete-admin-form-status'); // New Delete Admin Status Div

        // New Modal for Quick Reply Management
        const quickReplyModal = document.getElementById('quickReplyModal');
        const quickReplyListEditable = quickReplyModal.querySelector('.quick-reply-list-editable');
        // NEW: Input for Quick Reply Shortcut
        const newQuickReplyShortcutInput = quickReplyModal.querySelector('#new-quick-reply-shortcut');
        const newQuickReplyTextarea = quickReplyModal.querySelector('#new-quick-reply-text');
        const addQuickReplyButton = quickReplyModal.querySelector('#add-quick-reply-button');
        const saveQuickRepliesButton = quickReplyModal.querySelector('#save-quick-replies-button');
        const quickReplyFormStatusDiv = quickReplyModal.querySelector('.quick-reply-form-status');
        const quickRepliesContainer = document.getElementById('quick-replies-container'); // Container for quick reply buttons in chat area

        // NEW: Modal for Delete Quick Reply Confirmation
        const confirmDeleteQRModal = document.getElementById('confirmDeleteQRModal');
        const confirmDeleteQRMessage = confirmDeleteQRModal.querySelector('#confirm-delete-qr-message');
        const confirmDeleteQRYesButton = confirmDeleteQRModal.querySelector('#confirm-delete-qr-yes');
        const confirmDeleteQRNoButton = confirmDeleteQRModal.querySelector('#confirm-delete-qr-no');
         // State to hold the template object { shortcut, text } pending deletion
         let templateToDelete = null;

        // NEW: Modal for Delete ALL Chats Confirmation
         const confirmDeleteAllChatsModal = document.getElementById('confirmDeleteAllChatsModal');
         const confirmDeleteAllChatsYesButton = confirmDeleteAllChatsModal.querySelector('#confirm-delete-all-chats-yes');
         const confirmDeleteAllChatsNoButton = confirmDeleteAllChatsModal.querySelector('#confirm-delete-all-chats-no');


        // --- Application State ---
        let currentChatId = null; // ID Chat yang sedang dibuka
        let currentUser = null; // Username admin yang login
        let currentUserRole = null; // Role admin yang login (admin/superadmin)
        let chatHistory = {}; // { chatId: { status: 'open'|'closed', messages: [...] } } - Mirror server history state
        let chatListItems = {}; // { chatId: liElement } - Reference to DOM elements
        let pickedChatsStatus = {}; // { chatId: adminUsername } - Mirror server pick state (updated via socket)
        let registeredAdmins = {}; // { username: { initials, role } } - List of all registered admins (updated via socket)
        let onlineAdmins = []; // Array of online admin usernames (updated via socket)
        let currentQrCode = null; // State variable to hold the last received QR code data
        let currentQrStatus = 'Memuat status WA...'; // State variable for QR/WA status text

        // quickReplies and editingQuickReplies now store objects { shortcut, text }
        let quickReplies = []; // Array of { shortcut: string, text: string }
        let editingQuickReplies = []; // Temporary state for quick reply modal editing (Array of { shortcut: string, text: string })


        // Track offline admin notifications to avoid repeated alerts for the same admin
        const offlineAdminNotified = new Set();

        // --- Helper Functions ---

        // Function to get CSS Variable value
        function getCssVariable(name) {
            // Get the computed style of the root element
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        // Helper to show alerts from server events (Super Admin actions, etc.)
        function showServerAlert(message, isSuccess = true) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `server-alert ${isSuccess ? 'success' : 'error'}`;
            alertDiv.textContent = message;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.style.opacity = 0;
                setTimeout(() => alertDiv.remove(), 500); // Remove after fade out matches transition
            }, 5000); // Show for 5 seconds
        }


        function showLoginError(message) {
            loginError.textContent = message;
            // Use getCssVariable to get the color value from CSS
             if (message.toLowerCase().includes('berhasil') || message.toLowerCase().includes('menghubungkan kembali')) {
                  loginError.style.color = getCssVariable('--light-green');
             } else if (message.toLowerCase().includes('memproses')) {
                   loginError.style.color = getCssVariable('--text-dark');
             }
             else {
                loginError.style.color = getCssVariable('--error-color');
            }
        }

         function updateWhatsappStatus(statusText, isConnected) {
             currentQrStatus = statusText; // Update internal status variable
             whatsappStatusDiv.textContent = `Status WA: ${statusText}`; // Update sidebar display
             whatsappStatusDiv.style.color = isConnected ? '#a0ffa0' : '#ffb0b0'; // Light green for connected, light red for disconnected

             // Also update the status text in the QR modal if it's open
             if (qrModal.style.display !== 'none') {
                  qrStatus.textContent = statusText;
             }

             // If WA is disconnected and requires QR (or fatal error), update QR modal content (Super Admin only)
             // This is handled by specific WA event handlers below.
         }


        function setLoginState(isLoggedIn, username = null, role = null, initialPicks = {}) {
            if (isLoggedIn) {
                currentUser = username;
                currentUserRole = role; // Store the role
                localStorage.setItem('loggedInUsername', username);
                // localStorage.setItem('currentUserRole', role); // Optional: store role
                adminUsernameDisplay.textContent = `Admin: ${username}`;
                adminRoleDisplay.textContent = `Role: ${role === 'superadmin' ? 'Super Admin' : 'Admin Biasa'}`; // Display role
                pickedChatsStatus = initialPicks || {}; // Set initial picks received
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden'); // Show app container
                console.log(`[UI] Login state set: Logged in as ${username} with role ${role}.`);
                showLoginError(''); // Clear any previous login messages
                requestNotificationPermission();
                // Show/hide Super Admin panel based on role
                superadminPanel.style.display = (currentUserRole === 'superadmin') ? 'flex' : 'none';

                 // Ensure QR button and Quick Reply manage button are shown only for Super Admin
                 if (currentUserRole === 'superadmin') {
                     showQrButton.style.display = 'flex'; // Use flex for icon alignment
                      manageQuickRepliesButton.style.display = 'flex'; // Use flex for icon alignment
                 } else {
                     showQrButton.style.display = 'none';
                     manageQuickRepliesButton.style.display = 'none';
                 }

                // Request initial data will be handled by the server logic on successful login/reconnect (via 'request_initial_data' emission)
                // Also request quick replies
                 socket.emit('get_quick_replies');


                 // On successful login/reconnect, clear any old QR display
                 currentQrCode = null; // Clear stored QR data
                 qrCodeDiv.innerHTML = ''; // Clear QR code display in the modal
                 // qrStatus text will be updated by updateWhatsappStatus
                 qrModal.style.display = 'none'; // Ensure QR modal is hidden

            } else {
                currentUser = null;
                currentUserRole = null; // Clear role on logout
                localStorage.removeItem('loggedInUsername'); // Clear username
                // localStorage.removeItem('currentUserRole', role); // Optional
                loginContainer.classList.remove('hidden'); // Show login container
                appContainer.classList.add('hidden'); // Hide app container
                resetUI(); // Reset all UI and state
                usernameInput.value = '';
                passwordInput.value = '';
                console.log('[UI] Login state set: Logged out.');
                showLoginError('Silakan login kembali.');
                 updateWhatsappStatus('Disconnected', false); // Assume disconnected on logout
                superadminPanel.style.display = 'none'; // Hide Super Admin panel
                 showQrButton.style.display = 'none'; // Hide QR button on logout
                 manageQuickRepliesButton.style.display = 'none'; // Hide Quick Reply button

                 // Hide and clear QR modal explicitly on logout
                 qrModal.style.display = 'none';
                 qrCodeDiv.innerHTML = '';
                 qrStatus.textContent = '';
                 currentQrCode = null;
                 currentQrStatus = 'Memuat status WA...'; // Reset status
            }
        }

        function requestNotificationPermission() {
            // Check if the browser supports Notifications
            if ('Notification' in window) {
                // Check if permission is already granted or denied
                if (Notification.permission !== "granted" && Notification.permission !== 'denied') {
                    // Request permission from the user
                    Notification.requestPermission().then(permission => {
                        console.log(`Notification permission: ${permission}`);
                    });
                }
            } else {
                 console.warn("Browser does not support Notifications.");
            }
        }

        function updateChatStatusIndicator(chatId, status) {
            const chatListItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (!chatListItem) return;
            
            // Remove any existing status indicators
            const existingIndicator = chatListItem.querySelector('.chat-status');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Add new status indicator if status is not 'open'
            if (status !== 'open') {
                const statusIndicator = document.createElement('div');
                statusIndicator.className = 'chat-status';
                statusIndicator.textContent = status;
                chatListItem.appendChild(statusIndicator);
            }
        }
        
        function showNotification(title, body, options = {}) {
            console.log(`[UI] Showing notification: ${title} - ${body}`);
            
            // Check if browser supports notifications
            if (!("Notification" in window)) {
                console.warn("[UI] This browser does not support desktop notifications");
                return;
            }
            
            // Check if permission is already granted
            if (Notification.permission === "granted") {
                createNotification(title, body, options);
            } 
            // Otherwise, ask for permission
            else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        createNotification(title, body, options);
                    }
                });
            }
        }
        
        function createNotification(title, body, options = {}) {
            const notification = new Notification(title, {
                body: body,
                icon: '/favicon.ico',
                ...options
            });
            
            // Add click event to open the chat if chatId is provided
            if (options.chatId) {
                notification.onclick = function() {
                    window.focus();
                    openChat(options.chatId);
                };
            }
            
            // Auto close after 5 seconds
            setTimeout(() => {
                notification.close();
            }, 5000);
        }

        function resetChatArea() {
            updateChatAreaForCurrentChat(); // Re-evaluate UI state
        }

        socket.on('send_error', ({ to, text, media, message }) => {
            console.error(`Failed to send message to ${to}: ${message}`);
            // If the error is for the current chat
            if (to === currentChatId) {
                showSendError(message); // Display error message in reply box area
                // Restore input value and media selection
                replyInput.value = text || '';
                selectedMedia = media; // Restore selected media object (should be stored before sending)
                updateMediaPreview();
                // Re-enable input and button while sending to prevent double sends
                 replyInput.disabled = false;
                 replyButton.disabled = false;
                 mediaButton.disabled = false;
                 // Re-enable quick reply buttons
                 quickRepliesContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);

                 replyInput.focus(); // Put focus back on input
                 // Auto-size textarea after restoring text
                  replyInput.style.height = 'auto';
                  replyInput.style.height = replyInput.scrollHeight + 'px';

            } else {
                 // For errors on non-active chats, show a general server alert
                 showServerAlert(`Gagal mengirim pesan ke ${to?.split('@')[0] || 'ID tidak valid'}: ${message}`, false);
            }
        });

        socket.on('reply_sent_confirmation', ({ sentMsgId, chatId }) => {
            console.log(`Message sent confirmation received for ID: ${sentMsgId}`);
             // If confirmation is for the current chat, re-enable the reply box
             if (chatId === currentChatId) {
                 replyInput.disabled = false;
                 replyButton.disabled = false;
                 mediaButton.disabled = false;
                  // Re-enable quick reply buttons
                 quickRepliesContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
                 replyInput.focus(); // Put focus back
             }
        });


        socket.on('update_chat_read_status', ({ chatId }) => {
             console.log(`Chat ${chatId} read status updated (likely by another admin or after pick).`);
             // Update the unread indicator for this chat in the list
             // The actual unread state change is handled server-side and implicitly via initial_data or new_message containing updated unread flags.
             // This event primarily signals the UI to re-check the unread status.
             updateUnreadIndicator(chatId);
        });

        socket.on('auto_release_notification', ({ chatId, message }) => {
             console.log(`Received auto-release notification for chat ${chatId}: ${message}`);
             showServerAlert(message, true); // Use a success style alert for notification

             // The pick status for this chat will be updated by 'update_pick_status' event triggered by the server
             // after auto-release. So no need to manually update pick status here.
        });


        socket.on('delegate_success', ({ chatId, targetAdminUsername }) => {
            console.log(`Delegation success: ${chatId} to ${targetAdminUsername}`);
            // Show a confirmation message to the sender admin
            showServerAlert(`Chat ${chatId?.split('@')[0] || 'yang dipilih'} berhasil didelegasikan ke ${targetAdminUsername}.`, true);
             // The UI update (pick status changing) will be handled by the 'update_pick_status' event that follows this.
             // No need to explicitly update pickedChatsStatus or UI here.
             // Reset delegate select after success
             delegateChatSelect.value = ""; // Select the disabled option
              // Re-enable delegate buttons
              delegateChatButton.disabled = false;
              delegateChatSelect.disabled = false;

        });

        socket.on('delegate_error', ({ chatId, message }) => {
            console.error(`Delegation error for chat ${chatId}: ${message}`);
            // Show an error message to the sender admin
            showServerAlert(`Gagal mendelegasikan chat ${chatId?.split('@')[0] || 'yang dipilih'}: ${message}`, false);
             // Re-enable delegate button if it was disabled (shouldn't be disabled currently, but good practice)
             delegateChatButton.disabled = false;
             delegateChatSelect.disabled = false;
             // Reset delegate select value if needed (optional)
             // delegateChatSelect.value = "";
        });

        socket.on('chat_delegated_to_you', ({ chatId, fromAdmin, message }) => {
            console.log(`Chat ${chatId} delegated to you by ${fromAdmin}`);
             // Show a notification to the target admin
             showServerAlert(message, true);
             // If the chat is currently viewed, update the area (this will show it's now picked by current user)
            if (chatId === currentChatId) {
                 updateChatAreaForCurrentChat(); // Update the header/actions area
                 // Optionally focus the input as they are now the picker
                 replyInput.focus();
            } else {
                // If not the current chat, show a desktop notification (if enabled)
                showNotification(`Chat Didelegasikan`, message, { chatId: chatId });
            }
             // The pick status state (pickedChatsStatus) will be updated by the 'update_pick_status' event that the server sends.
        });


        socket.on('update_online_admins', (onlineAdminsList) => {
            console.log('[SOCKET] Received updated online admins:', onlineAdminsList);
            onlineAdmins = onlineAdminsList || []; // Update the online admins state
            // Repopulate the delegate select dropdown to reflect the current online status
            populateDelegateChatSelect();
        });

        socket.on('registered_admins', (registeredAdminList) => {
            console.log('[SOCKET] Received updated registered admins:', registeredAdminList);
            registeredAdmins = registeredAdminList || {}; // Update the registered admins state
             // Repopulate the delegate select dropdown as the list of potential delegates has changed
            populateDeleteAdminSelect(); // Also update delete admin select
             // Also update Super Admin panel visibility if needed (though should be set on login)
             if (currentUserRole === 'superadmin') {
                 superadminPanel.style.display = 'flex';
             }
        });

        // --- NEW Quick Reply Socket Event Handlers ---

         socket.on('quick_replies_updated', (templates) => {
             console.log('[SOCKET] Received updated quick replies:', templates);
             // Ensure templates is an array of objects { shortcut, text }
             quickReplies = Array.isArray(templates) ? templates.filter(item => item && typeof item.shortcut === 'string' && typeof item.text === 'string') : [];
             // Sort quick replies by shortcut alphabetically
             quickReplies.sort((a, b) => a.shortcut.localeCompare(b.shortcut));

             renderQuickReplyButtons(); // Re-render the quick reply buttons in the chat area

             // If the quick reply modal is open, update the editable list as well
             if (quickReplyModal.style.display !== 'none') {
                  // Deep copy for editing state and sort it
                  editingQuickReplies = quickReplies.map(item => ({ ...item }));
                  editingQuickReplies.sort((a, b) => a.shortcut.localeCompare(b.shortcut));

                  renderEditableQuickReplies(); // Re-render the list in the modal
                   quickReplyFormStatusDiv.textContent = 'Template berhasil diperbarui dari server.'; // Show status
                   quickReplyFormStatusDiv.className = 'quick-reply-form-status success';
                    // Re-enable save button and inputs
                    saveQuickRepliesButton.disabled = false;
                    newQuickReplyShortcutInput.disabled = false; // Enable shortcut input
                    newQuickReplyTextarea.disabled = false;
                    addQuickReplyButton.disabled = false;
             }
         });

         // --- Super Admin Event Handlers ---

        socket.on('superadmin_error', ({ message }) => {
            console.error(`Super Admin Error: ${message}`);
             showServerAlert(message, false); // Show error as a server alert

             // If a Super Admin modal is open, show error there too
              if (addAdminModal.style.display !== 'none') {
                 const addAdminStatusDiv = addAdminModal.querySelector('.add-admin-form-status');
                 addAdminStatusDiv.textContent = message;
                 addAdminStatusDiv.className = 'add-admin-form-status error';
                 // Do not close the modal on error
             } else if (deleteAdminModal.style.display !== 'none') {
                  const deleteAdminStatusDiv = deleteAdminModal.querySelector('.delete-admin-form-status');
                   deleteAdminStatusDiv.textContent = message;
                   deleteAdminStatusDiv.className = 'delete-admin-form-status error';
              } else if (quickReplyModal.style.display !== 'none') {
                   quickReplyFormStatusDiv.textContent = message;
                   quickReplyFormStatusDiv.className = 'quick-reply-form-status error';
                    // Re-enable save button and inputs
                    saveQuickRepliesButton.disabled = false;
                    newQuickReplyShortcutInput.disabled = false; // Enable shortcut input
                    newQuickReplyTextarea.disabled = false;
                    addQuickReplyButton.disabled = false;
              } else if (confirmDeleteAllChatsModal.style.display !== 'none') {
                   // Show error in the delete all modal and re-enable buttons
                   confirmDeleteAllChatsModal.querySelector('.modal-content p:last-of-type').textContent = `Gagal menghapus: ${message}`;
                   confirmDeleteAllChatsModal.querySelector('.modal-content p:last-of-type').style.color = getCssVariable('--error-color');
                   confirmDeleteAllChatsModal.querySelector('.modal-content .modal-buttons').style.display = 'flex'; // Show buttons again
              }

             // Re-enable admin action buttons if they were disabled (assuming they were disabled before emit)
              // This needs to be more specific based on which action failed if multiple actions are involved
              // For simplicity here, assuming general error state might need these re-enabled:
               submitAddAdminButton.disabled = false;
               newAdminUsernameInput.disabled = false; // Might be disabled if Add Admin modal open
               newAdminPasswordInput.disabled = false; // Might be disabled
               newAdminInitialsInput.disabled = false; // Might be disabled
               newAdminRoleSelect.disabled = false; // Might be disabled

               submitDeleteAdminButton.disabled = deleteAdminSelect.value === "" || !registeredAdmins || Object.keys(registeredAdmins).filter(u => u !== currentUser).length === 0; // Re-evaluate delete admin button state
               deleteAdminSelect.disabled = false; // Might be disabled

               // The save button in quick reply modal is re-enabled above if that modal is open.
               // Delete all chats button:
               deleteAllChatsButton.disabled = false;
        });

        socket.on('superadmin_success', ({ message }) => {
             console.log(`Super Admin Success: ${message}`);
             showServerAlert(message, true); // Show success as a server alert

             // If a Super Admin modal is open, show success there and close after a delay
              if (addAdminModal.style.display !== 'none') {
                 const addAdminStatusDiv = addAdminModal.querySelector('.add-admin-form-status');
                 addAdminStatusDiv.textContent = message;
                 addAdminStatusDiv.className = 'add-admin-form-status success';
                 // Re-enable input fields just in case
                  newAdminUsernameInput.disabled = false;
                  newAdminPasswordInput.disabled = false;
                  newAdminInitialsInput.disabled = false;
                  newAdminRoleSelect.disabled = false;
                  submitAddAdminButton.disabled = false;

                  setTimeout(() => addAdminModal.style.display = 'none', 1500); // Close modal on success
             } else if (deleteAdminModal.style.display !== 'none') {
                  const deleteAdminStatusDiv = deleteAdminModal.querySelector('.delete-admin-form-status');
                   deleteAdminStatusDiv.textContent = message;
                   deleteAdminStatusDiv.className = 'delete-admin-form-status success';
                   // Re-enable button just in case
                    submitDeleteAdminButton.disabled = false;
                     deleteAdminSelect.disabled = false;
                    setTimeout(() => deleteAdminModal.style.display = 'none', 1500); // Close modal on success
               } else if (quickReplyModal.style.display !== 'none') {
                   quickReplyFormStatusDiv.textContent = message;
                   quickReplyFormStatusDiv.className = 'quick-reply-form-status success';
                   // Update the main state from editing state on successful save
                    quickReplies = editingQuickReplies.map(item => ({ ...item })); // Deep copy
                    quickReplies.sort((a, b) => a.shortcut.localeCompare(b.shortcut)); // Keep sorted
                    renderQuickReplyButtons(); // Re-render chat area buttons

                   // Re-enable save button and inputs
                    saveQuickRepliesButton.disabled = false;
                    newQuickReplyShortcutInput.disabled = false;
                    newQuickReplyTextarea.disabled = false;
                    addQuickReplyButton.disabled = false;

                   setTimeout(() => quickReplyModal.style.display = 'none', 1500); // Close modal on success
               } else if (confirmDeleteAllChatsModal.style.display !== 'none') {
                   // Show success in the delete all modal before closing
                    confirmDeleteAllChatsModal.querySelector('.modal-content p:last-of-type').textContent = message;
                   confirmDeleteAllChatsModal.querySelector('.modal-content p:last-of-type').style.color = getCssVariable('--light-green'); // Success color
                    confirmDeleteAllChatsModal.querySelector('.modal-content .modal-buttons').style.display = 'none'; // Hide buttons

                   // Close the modal after a delay. The UI will be fully reset by 'all_chat_history_deleted' event.
                    setTimeout(() => confirmDeleteAllChatsModal.style.display = 'none', 1500);
               }


             // After success, re-populate relevant dropdowns just in case
             populateDelegateChatSelect();
             populateDeleteAdminSelect();
        });

         socket.on('chat_history_deleted', ({ chatId }) => {
             console.log(`Chat history deleted for ${chatId}.`);
             // Remove the chat from local state
             delete chatHistory[chatId];
             // Remove the list item from UI and its reference
             const listItem = chatListItems[chatId];
              if (listItem) {
                 listItem.remove();
             }
             delete chatListItems[chatId];
             // Remove pick status for this chat from local state
             delete pickedChatsStatus[chatId];

             // If the deleted chat was the one currently viewed, reset the chat area
             if (currentChatId === chatId) {
                 currentChatId = null; // Clear current chat
                 resetChatArea(); // Reset UI
             }
             // If the chat list is now empty, show the placeholder
             if (chatList.children.length === 0 || (chatList.children.length === 1 && chatList.querySelector('.placeholder'))) {
                 chatList.innerHTML = '<div class="placeholder" style="color: rgba(255,255,255,0.7); text-align: center; margin-top: 20px;">Tidak ada percakapan.</div>';
             }
              // No need to explicitly call update_pick_status or initial_pick_status here,
              // as the server already broadcasts initial_pick_status after deletion.
         });

        socket.on('all_chat_history_deleted', () => {
            console.log('All chat history deleted.');
             // Show a success alert *before* resetting the UI if confirm modal was open
            // This alert is already handled by superadmin_success if the modal was open.
            // If action triggered otherwise (e.g. server restart logic), the alert might show globally.

            // Reset all UI elements and state
            resetUI();
             // Show the empty chat list placeholder
            chatList.innerHTML = '<div class="placeholder" style="color: rgba(255,255,255,0.7); text-align: center; margin-top: 20px;">Tidak ada percakapan.</div>';
             // initial_pick_status with empty state will be broadcast by server.
        });

        socket.on('chat_status_updated', ({ chatId, status }) => {
            console.log(`Chat status updated for ${chatId} to ${status}.`);
            // Update chat status in local state
            if (chatHistory[chatId]) {
                 chatHistory[chatId].status = status;
            }
            // Update the status display on the chat list item
             updateChatListItemStatus(chatId, status);

             // If the updated chat is the one currently viewed, update the chat area UI
             if (chatId === currentChatId) {
                 updateChatAreaForCurrentChat(); // This re-evaluates button/reply box states
             }
        });


        // --- UI Event Listeners ---

        // Login button click handler
        loginButton.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            hideSendError(); // Hide any previous send errors
            if (username && password) {
                console.log('[UI] Attempting login with username:', username); // Log attempt
                showLoginError('Memproses login...'); // Show processing message
                loginButton.disabled = true; // Disable button to prevent double-click
                socket.emit('admin_login', { username, password }); // Emit login event
            } else {
                showLoginError('Username dan password harus diisi.'); // Show validation error
            }
        });

        // Allow login on Enter key press in password input
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default form submission if in a form
                loginButton.click(); // Trigger login button click
            }
        });

        // Logout button click handler
        logoutButton.addEventListener('click', () => {
            console.log('[UI] Logout initiated by user.');
            if (socket.connected) {
                socket.emit('admin_logout'); // Notify server of logout
            }
            // Immediately change UI to logged out state
            setLoginState(false); // This resets the UI and state
             // The server will handle state cleanup and disconnecting the socket if needed.
        });


        // Pick chat button click handler
        pickChatButton.addEventListener('click', () => {
             // Ensure a chat is selected, user is logged in, and chat is not already picked
            if (currentChatId && currentUser && !pickedChatsStatus[currentChatId]) {
                 // Check chat status from local state
                 const chatStatus = chatHistory[currentChatId]?.status || 'open';
                 if (chatStatus === 'closed') {
                      alert('Tidak bisa mengambil chat yang sudah ditutup.');
                      return; // Prevent picking a closed chat
                 }
                console.log(`[UI] Attempting to pick chat: ${currentChatId}`);
                pickChatButton.disabled = true; // Disable button
                pickChatButton.textContent = 'Mengambil...'; // Change button text
                 releaseChatButton.disabled = true; // Disable release button while picking (should be hidden anyway)
                socket.emit('pick_chat', { chatId: currentChatId }); // Emit pick event
            } else {
                 console.warn("[UI] Pick button clicked in invalid state:", { currentChatId, currentUser, picked: pickedChatsStatus[currentChatId] });
                 // Optional: Show a small error message or just do nothing
            }
        });

         // Release chat button click handler (NEW)
         releaseChatButton.addEventListener('click', () => {
             // Ensure a chat is selected, user is logged in, and chat is picked by THIS user
             if (currentChatId && currentUser && pickedChatsStatus[currentChatId] === currentUser) {
                  console.log(`[UI] Attempting to release chat: ${currentChatId}`);
                  // Add logs to check the condition
                  console.log('[UI Debug Release] currentChatId:', currentChatId);
                  console.log('[UI Debug Release] currentUser:', currentUser);
                  console.log('[UI Debug Release] pickedChatsStatus[currentChatId]:', pickedChatsStatus[currentChatId]);
                  console.log('[UI Debug Release] pickedChatsStatus[currentChatId] === currentUser:', pickedChatsStatus[currentChatId] === currentUser);


                  const chatStatus = chatHistory[currentChatId]?.status || 'open';
                   if (chatStatus === 'closed') {
                       alert('Tidak bisa melepas chat yang sudah ditutup.'); // Should be hidden anyway by UI logic
                       console.warn('[UI] Attempted to release a closed chat.');
                       // Re-enable button if this happens unexpectedly
                       releaseChatButton.disabled = false;
                       releaseChatButton.textContent = 'Lepas Chat';
                       return;
                   }

                  releaseChatButton.disabled = true; // Disable button
                  releaseChatButton.textContent = 'Melepas...'; // Change button text
                   pickChatButton.disabled = true; // Disable pick button while releasing (should be hidden anyway)

                  socket.emit('unpick_chat', { chatId: currentChatId }); // Emit unpick event
             } else {
                  console.warn("[UI] Release button clicked in invalid state:", { currentChatId, currentUser, picked: pickedChatsStatus[currentChatId] });
                  // Optional: Show error
                  alert('Gagal melepas chat. Chat mungkin belum diambil oleh Anda.');
             }
         });


        // Delegate button click handler
        delegateChatButton.addEventListener('click', () => {
            const targetAdminUsername = delegateChatSelect.value; // Get selected admin username
            // Validate selection
            if (!targetAdminUsername) {
                 alert('Pilih admin tujuan untuk delegasi.');
                 return; // Stop if no target admin is selected
             }

             // Check chat status from local state
             const chatStatus = chatHistory[currentChatId]?.status || 'open';
             if (chatStatus === 'closed') {
                  alert('Tidak bisa mendelegasikan chat yang sudah ditutup.');
                  return; // Prevent delegating a closed chat
             }

             // Get selected option to check online status visually (server does the final check)
             const selectedOption = delegateChatSelect.options[delegateChatSelect.selectedIndex];
             const isOnline = selectedOption?.classList.contains('online') || false;

             // Check if current user is Super Admin OR is the one who picked the chat (Backend also validates this)
             const pickedBy = pickedChatsStatus[currentChatId];
             if (currentUserRole !== 'superadmin' && pickedBy !== currentUser) {
                  alert('Anda tidak punya izin mendelegasikan chat ini. Ambil chat ini terlebih dahulu atau pastikan Anda Super Admin.');
                  return; // Prevent delegation if user is not allowed
             }


             // If target is offline and we haven't notified the user yet, show modal
            if (!isOnline && !offlineAdminNotified.has(targetAdminUsername)) {
                offlineAdminNotified.add(targetAdminUsername); // Add to set to prevent repeat modals
                offlineAdminMessage.textContent = `Admin ${targetAdminUsername} sedang offline. Delegasi akan tetap dilakukan, tetapi admin tersebut mungkin tidak segera menangani chat. Lanjutkan?`; // Customize message
                offlineAdminModal.style.display = 'flex'; // Show the modal
            } else {
                 // Proceed with delegation if target is online OR user clicked OK on offline modal
                 console.log(`[UI] Delegating chat ${currentChatId} to ${targetAdminUsername}`);
                 // Disable buttons while delegating
                 delegateChatButton.disabled = true;
                 delegateChatSelect.disabled = true;

                 socket.emit('delegate_chat', { chatId: currentChatId, targetAdminUsername }); // Emit delegate event
                 // Close the offline modal if it was open
                 if (offlineAdminModal.style.display === 'flex') {
                     offlineAdminModal.style.display = 'none';
                 }
                 // Reset delegate select value after delegation attempt
                 delegateChatSelect.value = ""; // Select the disabled option
            }
        });

         // Close offline admin modal handler
         offlineAdminModalClose.addEventListener('click', () => {
             offlineAdminModal.style.display = 'none'; // Hide the modal
             // Re-enable delegate buttons if they were disabled by the modal
              delegateChatButton.disabled = false;
              delegateChatSelect.disabled = false;
         });

         // Add Admin button click handler (Super Admin function)
         addAdminButton.addEventListener('click', () => {
             if (currentUserRole === 'superadmin') { // Check role before showing modal
                 addAdminModal.style.display = 'flex'; // Show the modal
                 // Clear form inputs and status
                  newAdminUsernameInput.value = '';
                  newAdminPasswordInput.value = '';
                  newAdminInitialsInput.value = '';
                  newAdminRoleSelect.value = 'admin'; // Default role
                  addAdminFormStatusDiv.textContent = '';
                  addAdminFormStatusDiv.className = 'add-admin-form-status'; // Reset class
                  newAdminUsernameInput.focus(); // Focus first input

                  // Re-enable buttons and inputs
                  newAdminUsernameInput.disabled = false;
                  newAdminPasswordInput.disabled = false;
                  newAdminInitialsInput.disabled = false;
                  newAdminRoleSelect.disabled = false;
                  submitAddAdminButton.disabled = false;

             } else {
                  showServerAlert('Akses ditolak. Anda bukan Super Admin.', false); // Role check fallback
             }
         });

        // Submit Add Admin form handler (Super Admin function)
        submitAddAdminButton.addEventListener('click', () => {
             if (currentUserRole !== 'superadmin') { // Double check role
                  showServerAlert('Akses ditolak.', false);
                  return;
             }
             // Get form values and trim whitespace
             const username = newAdminUsernameInput.value.trim();
             const password = newAdminPasswordInput.value.trim();
             const initials = newAdminInitialsInput.value.trim().toUpperCase(); // Convert initials to uppercase
             const role = newAdminRoleSelect.value;

             // Basic frontend validation
             if (!username || !password || !initials) {
                 addAdminFormStatusDiv.textContent = 'Username, password, dan initials harus diisi.';
                 addAdminFormStatusDiv.className = 'add-admin-form-status error';
                 return;
             }
             // Frontend validation for initials length
             if (initials.length === 0 || initials.length > 3) {
                  addAdminFormStatusDiv.textContent = 'Initials harus 1-3 karakter.';
                  addAdminFormStatusDiv.className = 'add-admin-form-status error';
                  return;
             }
             // Basic check if initials are alphanumeric (optional)
             if (!/^[A-Z]+$/.test(initials)) { // Check for uppercase letters only
                  addAdminFormStatusDiv.textContent = 'Initials hanya boleh berisi huruf besar.'; // Updated message
                  addAdminFormStatusDiv.className = 'add-admin-form-status error';
                  return;
             }


             addAdminFormStatusDiv.textContent = 'Menambahkan admin...';
             addAdminFormStatusDiv.className = 'add-admin-form-status'; // Clear error/success class

              // Disable input fields and buttons while processing
              newAdminUsernameInput.disabled = true;
              newAdminPasswordInput.disabled = true;
              newAdminInitialsInput.disabled = true;
              newAdminRoleSelect.disabled = true;
              submitAddAdminButton.disabled = true;


             // Emit add admin event to server
             socket.emit('add_admin', { username, password, initials, role });
             // Server will send superadmin_success/error response
        });

         // Delete Admin button click handler (NEW)
         deleteAdminButton.addEventListener('click', () => {
             if (currentUserRole === 'superadmin') { // Check role
                 deleteAdminModal.style.display = 'flex'; // Show modal
                  populateDeleteAdminSelect(); // Populate select when opening modal
                  deleteAdminFormStatusDiv.textContent = ''; // Clear status
                  deleteAdminFormStatusDiv.className = 'delete-admin-form-status';

                   // Re-enable buttons and select
                   submitDeleteAdminButton.disabled = deleteAdminSelect.value === "" || !registeredAdmins || Object.keys(registeredAdmins).filter(u => u !== currentUser).length === 0; // Re-evaluate disable state
                   deleteAdminSelect.disabled = false;

             } else {
                  showServerAlert('Akses ditolak. Anda bukan Super Admin.', false);
             }
         });

          // Submit Delete Admin form handler (NEW)
         submitDeleteAdminButton.addEventListener('click', () => {
             const usernameToDelete = deleteAdminSelect.value; // Get selected username
             if (!usernameToDelete) {
                  deleteAdminFormStatusDiv.textContent = 'Pilih admin yang akan dihapus.';
                  deleteAdminFormStatusDiv.className = 'delete-admin-form-status error';
                  return;
             }

              // Double confirmation for deletion
             if (confirm(`Anda yakin ingin menghapus admin "${usernameToDelete}"? Tindakan ini tidak bisa dibatalkan.`)) {
                 console.log(`[UI] Super Admin ${currentUser} menghapus admin ${usernameToDelete}`);
                  deleteAdminFormStatusDiv.textContent = 'Menghapus admin...';
                   deleteAdminFormStatusDiv.className = 'delete-admin-form-status'; // Clear other classes

                  // Disable button while processing
                  submitDeleteAdminButton.disabled = true;
                  deleteAdminSelect.disabled = true;

                  socket.emit('delete_admin', { usernameToDelete }); // Emit delete admin event
                  // Server will respond with superadmin_success/error
             }
         });


        // Close modal buttons handler (generic)
        // Handles closing modals that have a button with class="close-modal-button" inside modal-content
        document.querySelectorAll('.modal-overlay').forEach(modalOverlay => {
            const closeButton = modalOverlay.querySelector('.modal-content .close-modal-button');
            if (closeButton) {
                 closeButton.addEventListener('click', (e) => {
                     // Get the parent modal overlay element
                     const modalElement = e.target.closest('.modal-overlay');
                     if (modalElement) {
                         const modalId = modalElement.id;

                         modalElement.style.display = 'none'; // Hide the target modal

                         // --- Reset state specific to each modal when closing via X ---
                         if (modalId === 'deleteAdminModal') {
                              // Re-evaluate disable state based on current registered admins
                              submitDeleteAdminButton.disabled = deleteAdminSelect.value === "" || !registeredAdmins || Object.keys(registeredAdmins).filter(u => u !== currentUser).length === 0;
                              deleteAdminSelect.disabled = false;
                         } else if (modalId === 'addAdminModal') {
                               newAdminUsernameInput.disabled = false;
                               newAdminPasswordInput.disabled = false;
                               newAdminInitialsInput.disabled = false;
                               newAdminRoleSelect.disabled = false;
                               submitAddAdminButton.disabled = false;
                         } else if (modalId === 'quickReplyModal') {
                               editingQuickReplies = quickReplies.map(item => ({ ...item })); // Revert changesmade in modal (Deep Copy)
                                editingQuickReplies.sort((a, b) => a.shortcut.localeCompare(b.shortcut)); // Keep sorted
                                renderEditableQuickReplies(); // Render the list to show original state again
                                quickReplyFormStatusDiv.textContent = '';
                                quickReplyFormStatusDiv.className = 'quick-reply-form-status';
                                saveQuickRepliesButton.disabled = false;
                                newQuickReplyShortcutInput.disabled = false;
                                newQuickReplyTextarea.disabled = false;
                                addQuickReplyButton.disabled = false;
                                newQuickReplyShortcutInput.value = ''; // Clear new template inputs
                                newQuickReplyTextarea.value = '';
                         } else if (modalId === 'confirmDeleteQRModal') {
                             // Reset pending deletion state
                             templateToDelete = null;
                             // Clear any temporary status message set by the delete click (in the main QR modal)
                              const qrMainStatusDiv = quickReplyModal.querySelector('.quick-reply-form-status');
                              if (qrMainStatusDiv) {
                                 qrMainStatusDiv.textContent = '';
                                 qrMainStatusDiv.className = 'quick-reply-form-status';
                              }

                         } else if (modalId === 'confirmDeleteAllChatsModal') {
                             // Reset the content of the delete all chats modal for the next time it's opened
                             confirmDeleteAllChatsModal.querySelector('.modal-content p:last-of-type').textContent = 'Lanjutkan?'; // Reset text
                             confirmDeleteAllChatsModal.querySelector('.modal-content p:last-of-type').style.color = getCssVariable('--button-danger-bg'); // Reset color
                             confirmDeleteAllChatsModal.querySelector('.modal-content .modal-buttons').style.display = 'flex'; // Show buttons again
                         } else if (modalId === 'qrModal') {
                              // Optional: clear the rendered QR if closing, but keep data in currentQrCode
                              // qrCodeDiv.innerHTML = '';
                         } else if (modalId === 'offlineAdminModal') {
                             // Nothing specific to reset here, just hide.
                         }
                     }
                 });
            }
        });


         // Delete single chat button click handler (Super Admin function)
         deleteChatButton.addEventListener('click', () => {
              // Check role and if a chat is selected
             if (currentUserRole !== 'superadmin' || !currentChatId) {
                  showServerAlert('Akses ditolak atau chat tidak dipilih.', false);
                  return;
             }
              // Get chat name for confirmation message
             const chatName = chatListItems[currentChatId]?.dataset.chatName || currentChatId.split('@')[0];
             // Show confirmation dialog
             if (confirm(`Anda yakin ingin menghapus riwayat chat untuk "${chatName}"? Tindakan ini tidak bisa dibatalkan.`)) {
                  console.log(`[UI] Super Admin ${currentUser} menghapus chat ${currentChatId}`);
                 socket.emit('delete_chat', { chatId: currentChatId }); // Emit delete event
             }
         });

         // Delete all chats button click handler (Super Admin function)
         deleteAllChatsButton.addEventListener('click', () => {
              // Check role
             if (currentUserRole !== 'superadmin') {
                  showServerAlert('Akses ditolak.', false);
                  return;
             }
              // Show the custom confirmation modal
             confirmDeleteAllChatsModal.style.display = 'flex';

             // Reset modal content visibility/text in case it was previously used for error/success message
             confirmDeleteAllChatsModal.querySelector('.modal-content p:last-of-type').textContent = 'Lanjutkan?';
             confirmDeleteAllChatsModal.querySelector('.modal-content p:last-of-type').style.color = getCssVariable('--button-danger-bg'); // Ensure warning color is applied
             confirmDeleteAllChatsModal.querySelector('.modal-content .modal-buttons').style.display = 'flex'; // Ensure buttons are visible

         });

         // NEW: Event Listeners for Custom Delete ALL Chats Confirmation Modal
         confirmDeleteAllChatsYesButton.addEventListener('click', () => {
              console.log('[UI] User confirmed deletion of ALL chats.');
              // Emit the socket event to delete all chats
              socket.emit('delete_all_chats');
              // The modal will be closed by the 'superadmin_success' or 'superadmin_error' handler
              // after the server responds.
              // For immediate feedback, show a "Processing..." message and hide buttons
               confirmDeleteAllChatsModal.querySelector('.modal-content p:last-of-type').textContent = 'Memproses penghapusan...';
               confirmDeleteAllChatsModal.querySelector('.modal-content p:last-of-type').style.color = getCssVariable('--text-dark'); // Change color while processing
               confirmDeleteAllChatsModal.querySelector('.modal-content .modal-buttons').style.display = 'none'; // Hide buttons
         });

         confirmDeleteAllChatsNoButton.addEventListener('click', () => {
             console.log('[UI] User cancelled deletion of ALL chats.');
             // Hide the confirmation modal
             confirmDeleteAllChatsModal.style.display = 'none';
              // Reset modal content visibility/text for next time it's opened (handled by deleteAllChatsButton click now)
              // confirmDeleteAllChatsModal.querySelector('.modal-content .modal-buttons').style.display = 'flex';
              // confirmDeleteAllChatsModal.querySelector('.modal-content p:last-of-type').textContent = 'Lanjutkan?';
         });


        // Handle file selection for media button
        mediaInput.addEventListener('change', (event) => {
            const file = event.target.files[0]; // Get the selected file
            if (file) {
                 // Basic file size validation (e.g., 25MB WhatsApp limit for media, larger for documents)
                 // Let's use a generous limit for simplicity here, adjust as needed.
                 const maxSizeBytes = 100 * 1024 * 1024; // 100MB
                 if (file.size > maxSizeBytes) {
                     alert(`Ukuran file (${(file.size / 1024 / 1024).toFixed(2)} MB) melebihi batas (${maxSizeBytes / (1024*1024)} MB).`);
                     mediaInput.value = null; // Clear the file input
                     selectedMedia = null; // Clear state
                     updateMediaPreview(); // Hide preview
                     return;
                 }

                 // Use FileReader to read the file as a Base64 string
                const reader = new FileReader();
                reader.onload = () => {
                    // Store the file data and info in the state variable
                    selectedMedia = {
                        data: reader.result.split(',')[1], // Get base64 part
                        type: file.type, // MIME type
                        name: file.name, // Original file name
                         // Optional: store the raw file object if needed later, but base64 is enough for sending
                        // rawFile: file
                    };
                    updateMediaPreview(); // Update the UI to show preview
                };
                reader.onerror = (error) => {
                     console.error("[UI] Error reading file:", error);
                     alert("Gagal membaca file media.");
                     mediaInput.value = null; // Clear the file input
                     selectedMedia = null; // Clear state
                     updateMediaPreview(); // Hide preview
                };
                reader.readAsDataURL(file); // Read file as Data URL (Base64)
            }
        });

        // Media button click handler - triggers the hidden file input
        mediaButton.addEventListener('click', () => {
            // Check if user can send messages (chat picked by them and open)
            if (!currentChatId || pickedChatsStatus[currentChatId] !== currentUser) {
                 alert('Silakan pilih dan ambil chat terlebih dahulu sebelum mengirim media.');
                 return;
             }
             const chatStatus = chatHistory[currentChatId]?.status || 'open';
             if (chatStatus === 'closed') {
                  alert('Tidak bisa mengirim media ke chat yang sudah ditutup.');
                  return;
             }
            mediaInput.click(); // Programmatically click the hidden file input
        });


        // Reply button click handler
        replyButton.addEventListener('click', () => {
            const text = replyInput.value.trim(); // Get text input value

            // Do not send if both text and media are empty
            if (!text && !selectedMedia) {
                 hideSendError(); // Ensure no old error is shown
                 replyInput.focus(); // Keep focus on input
                 return;
            }

            // Check if user is allowed to reply to the current chat (picked by them)
            if (currentChatId && pickedChatsStatus[currentChatId] === currentUser) {
                 // Check chat status
                 const chatStatus = chatHistory[currentChatId]?.status || 'open';
                 if (chatStatus === 'closed') {
                      showSendError('Tidak bisa mengirim balasan ke chat yang sudah ditutup.');
                      return; // Prevent sending to closed chat
                 }

                // Prepare message data
                const messageData = {
                  to: currentChatId,
                  text: text || null, // Use null if text is empty
                  media: selectedMedia || null // Use null if no media selected
                };

                // Disable input and button while sending to prevent double sends
                replyInput.disabled = true;
                replyButton.disabled = true;
                mediaButton.disabled = true; // Disable media button too
                 // Disable quick reply buttons
                 quickRepliesContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

                 hideSendError(); // Hide any previous error message

                 console.log('[UI] Sending message:', messageData); // Log message data before sending
                socket.emit('reply_message', messageData); // Emit reply event

                // Clear input and media state immediately after sending
                replyInput.value = '';
                selectedMedia = null;
                updateMediaPreview(); // Hide media preview
                 // Auto-size textarea after clearing
                 replyInput.style.height = 'auto'; // Reset height
                 replyInput.rows = 1; // Reset rows
                 // replyInput.style.height = replyInput.scrollHeight + 'px'; // Recalculate (may not be needed after clearing)

            } else {
                // User not allowed to send
                console.warn("[UI] Send attempt in invalid state:", { text, currentChatId, picked: pickedChatsStatus[currentChatId], currentUser });
                 showSendError('Pilih atau ambil chat terlebih dahulu.');
            }
        });

        // Allow sending message on Enter key press in textarea (Shift+Enter for newline)
        replyInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent default newline on Enter
                replyButton.click(); // Trigger reply button click
            }
        });

         // Auto-resize textarea based on content
         replyInput.addEventListener('input', () => {
             replyInput.style.height = 'auto'; // Reset height to calculate scrollHeight correctly
             replyInput.style.height = replyInput.scrollHeight + 'px'; // Set height to fit content
         });

        // --- Initialization ---

        // Run when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[UI] DOM fully loaded.');
             // Attempt to log in using stored username from previous session
            const storedUsername = localStorage.getItem('loggedInUsername');
            if (storedUsername) {
                 console.log('[UI] Found user in localStorage:', storedUsername);
                 showLoginError('Menghubungkan...'); // Show connection message
                 // Attempt to reconnect to the server with the stored username
                 socket.emit('admin_reconnect', { username: storedUsername });
             } else {
                 console.log('[UI] No user in localStorage. Showing login form.');
                 // No stored user, show the login form
                 setLoginState(false);
                 showLoginError(''); // Clear any default message
                 // Ensure QR modal and Quick Reply modal are hidden on initial load
                 qrModal.style.display = 'none';
                 quickReplyModal.style.display = 'none'; // Hide quick reply modal
                 confirmDeleteQRModal.style.display = 'none'; // Hide quick reply confirmation modal
                 confirmDeleteAllChatsModal.style.display = 'none'; // Hide delete ALL confirmation modal
             }

             // Fetch application version from config.json (if it exists)
             fetch('/config.json')
                 .then(response => {
                     // Handle case where config.json is not found
                     if (!response.ok) {
                         if (response.status === 404) {
                             console.warn('config.json not found. App version will be N/A.');
                             return null; // Or throw a specific error
                         }
                         throw new Error(`HTTP error! status: ${response.status}`);
                     }
                     return response.json();
                 })
                 .then(config => {
                     if (config && config.version) {
                         document.getElementById('app-version').textContent = config.version;
                     } else {
                         document.getElementById('app-version').textContent = 'N/A';
                     }
                 })
                 .catch(err => {
                     console.error('[UI] Gagal memuat versi aplikasi dari config.json:', err);
                     document.getElementById('app-version').textContent = 'N/A';
                 });

             // Add click handler to the initial chat list placeholder message
             const initialPlaceholder = chatList.querySelector('.placeholder');
             if(initialPlaceholder) {
                 initialPlaceholder.addEventListener('click', () => {
                     if (!currentUser) {
                          alert('Silakan login terlebih dahulu.');
                     } else if (whatsappStatusDiv.textContent.includes('Disconnected') || whatsappStatusDiv.textContent.includes('Connecting')) {
                         alert('Koneksi WhatsApp belum siap atau sedang dalam proses. Silakan tunggu atau periksa status di panel Super Admin.'); // Updated message
                     } else {
                          // This case should ideally not happen if initial data is loaded quickly
                          alert('Memuat percakapan... Jika ini berlangsung lama, periksa log server atau refresh halaman.');
                     }
                 });
             }

             // Initialize textarea height
             replyInput.style.height = 'auto';
             replyInput.rows = 1; // Set initial rows
             // Set height after a slight delay to ensure element is fully rendered
             setTimeout(() => {
                 replyInput.style.height = replyInput.scrollHeight + 'px';
             }, 0);

             // Initial render of quick reply buttons (will show placeholder if state is empty)
             renderQuickReplyButtons();


        });

        // Socket connection
        // Deklarasi socket sudah ada di bagian atas file
        socket.connect();
        
        // Socket connection status handling
        socket.on('connect', () => {
            console.log('[SOCKET] Connected to server');
            document.getElementById('connection-status').textContent = 'Connected';
        });
        
        socket.on('disconnect', () => {
            console.log('[SOCKET] Disconnected from server');
            document.getElementById('connection-status').textContent = 'Disconnected';
        });
        
        socket.on('connect_error', (error) => {
            console.error('[SOCKET] Connection error:', error);
            document.getElementById('connection-status').textContent = 'Connection Error';
        });
        
        socket.on('reconnect', (attemptNumber) => {
            console.log(`[SOCKET] Reconnected after ${attemptNumber} attempts`);
            document.getElementById('connection-status').textContent = 'Connected';
            
            // Request initial data if we're logged in
            if (currentUser) {
                socket.emit('request_initial_data');
            }
            
            // Show reconnection success message
            showServerAlert('Reconnected to server successfully!', false);
        });

    </script>

</body>
</html>